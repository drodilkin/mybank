<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>PayBank</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
--bg:#0b0b10;
--card:#17171f;
--input:#222230;
--accent:#ffd600;
--text:#fff;
--muted:#9b9ba3;
}

*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;}

body{
margin:0;
background:var(--bg);
color:var(--text);
min-height:100vh;
display:flex;
justify-content:center;
align-items:center;
}

.hidden{display:none;}

.auth{background:var(--card);padding:28px;border-radius:22px;width:100%;max-width:360px;}

.auth input,.auth button{
width:100%;
margin-top:12px;
padding:14px;
border:none;
border-radius:14px;
}

.auth input{background:var(--input);color:white;}
.auth button{background:var(--accent);font-weight:600;cursor:pointer;}

.app{width:100%;max-width:420px;padding:16px;}

.tabs{
display:flex;
gap:8px;
margin-top:16px;
}

.tabs button{
flex:1;
padding:12px;
border-radius:14px;
border:none;
background:#2a2a36;
color:white;
cursor:pointer;
}

.tabs button.active{
background:var(--accent);
color:black;
}

.card-wrap{perspective:1000px;}

.card{
width:100%;
height:170px;
border-radius:22px;
background:linear-gradient(135deg,#1e1e28,#121218);
padding:20px;
transition:.5s;
transform-style:preserve-3d;
cursor:pointer;
position:relative;
}

.card.flipped{transform:rotateY(180deg);}

.card-face{
position:absolute;
inset:0;
padding:20px;
backface-visibility:hidden;
}

.card-back{
transform:rotateY(180deg);
display:flex;
flex-direction:column;
justify-content:center;
}

.balance-title{color:var(--muted);}
.balance-amount{font-size:34px;}

.block{background:var(--card);border-radius:22px;padding:18px;margin-top:16px;}

.block input,.block select,.block button{
width:100%;
margin-top:12px;
padding:14px;
border:none;
border-radius:14px;
}

.block input,.block select{background:var(--input);color:white;}
.block button{background:var(--accent);font-weight:600;cursor:pointer;}

.history-item{
padding:12px 0;
border-bottom:1px solid #2a2a36;
opacity:0;
transform:translateY(10px);
animation:fadeIn .35s forwards;
}

@keyframes fadeIn{
to{
opacity:1;
transform:translateY(0);
}
}

.in{color:#2ecc71;}
.out{color:#ff4d4f;}

.logout{background:#2a2a36!important;color:white;}
</style>
</head>

<body>

<div class="auth" id="auth">
<h1>PayBank</h1>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å">
<button onclick="login()">–í–æ–π—Ç–∏</button>
</div>

<div class="app hidden" id="app">

<div class="card-wrap">
<div class="card" id="bankCard" onclick="flipCard()">
<div class="card-face">
<div class="balance-title">–ë–∞–ª–∞–Ω—Å</div>
<div class="balance-amount" id="balance">0 ‚ÇΩ</div>
</div>

<div class="card-face card-back">
<div class="balance-title">–ù–æ–º–µ—Ä –∫–∞—Ä—Ç—ã</div>
<div class="balance-amount" id="cardNumber"></div>
</div>
</div>
</div>

<!-- üî• –í–ö–õ–ê–î–ö–ò -->
<div class="tabs">
<button onclick="openTab('transferTab',this)" class="active">–ü–µ—Ä–µ–≤–æ–¥—ã</button>
<button onclick="openTab('nfcTab',this)">NFC</button>
<button onclick="openTab('historyTab',this)">–ò—Å—Ç–æ—Ä–∏—è</button>
</div>

<!-- –ü–ï–†–ï–í–û–î–´ -->
<div id="transferTab">

<div class="block">
<select id="to"></select>
<input id="amount" type="number" placeholder="–°—É–º–º–∞">
<input id="comment" placeholder="–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π">
<button onclick="transfer()">–ü–µ—Ä–µ–≤–µ—Å—Ç–∏</button>
</div>

</div>

<!-- NFC -->
<div id="nfcTab" class="hidden">

<div class="block">
<h3>–ü—Ä–∏–ª–æ–∂–∏—Ç—å –∫–∞—Ä—Ç—É</h3>
<button onclick="startNFC()">üì° –ù–∞—á–∞—Ç—å —Å–∫–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ</button>
<div id="nfcStatus"></div>
</div>

</div>

<!-- –ò–°–¢–û–†–ò–Ø -->
<div id="historyTab" class="hidden">

<div class="block">
<button onclick="downloadStatement()">–°–∫–∞—á–∞—Ç—å –≤—ã–ø–∏—Å–∫—É</button>
</div>

<div class="block">
<button onclick="toggleHistory()">–ü–æ–∫–∞–∑–∞—Ç—å / —Å–∫—Ä—ã—Ç—å –ø–µ—Ä–µ–≤–æ–¥—ã</button>
<div id="history"></div>
</div>

</div>

<button class="block logout" onclick="logout()">–í—ã–π—Ç–∏</button>

</div>

<script>
const API='https://script.google.com/macros/s/AKfycbzpREMs_CGdEJaD78SW7zzsepJdVh4cis93U9qdhz_uFBRPklq4YT3bf9jzmhUIEPRcPg/exec';

let userEmail='';
let lastHistory=[];
let autoUpdateInterval=null;
let lastTxCount=0;
let historyVisible=true;

const names={
'ilyasvaliev@mail.ru':'–ò–ª—å—è—Å',
'prokhormart@mail.ru':'–ü—Ä–æ—Ö–æ—Ä',
'romankisel@mail.ru':'–†–æ–º–∞–Ω',
'artemant@mail.ru':'–ê—Ä—Ç–µ–º'
};

const emailInput=document.getElementById('email');
const passwordInput=document.getElementById('password');
const auth=document.getElementById('auth');
const app=document.getElementById('app');
const balance=document.getElementById('balance');
const cardNumber=document.getElementById('cardNumber');
const bankCard=document.getElementById('bankCard');
const to=document.getElementById('to');
const amount=document.getElementById('amount');
const comment=document.getElementById('comment');
const historyEl=document.getElementById('history');

function openTab(id,btn){
document.querySelectorAll('#transferTab,#nfcTab,#historyTab')
.forEach(e=>e.classList.add('hidden'));

document.getElementById(id).classList.remove('hidden');

document.querySelectorAll('.tabs button')
.forEach(b=>b.classList.remove('active'));

btn.classList.add('active');
}

async function startNFC(){

const status=document.getElementById('nfcStatus');

if(!('NDEFReader' in window)){
status.textContent='NFC –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è';
return;
}

const reader=new NDEFReader();

await reader.scan();

status.textContent='üì° –ü–æ–¥–Ω–µ—Å–∏—Ç–µ –∫–∞—Ä—Ç—É...';

reader.onreading=e=>{

const id=e.serialNumber;

status.textContent='üí≥ –ö–∞—Ä—Ç–∞ —Å—á–∏—Ç–∞–Ω–∞: '+id;

if(id===cardNumber.textContent){
pushNotify('üí≥ –í–∞—à–∞ –∫–∞—Ä—Ç–∞',balance.textContent);
}else{
to.value=findUserByCard(id);
pushNotify('üí≥ –ü–æ–ª—É—á–∞—Ç–µ–ª—å –≤—ã–±—Ä–∞–Ω','–ú–æ–∂–Ω–æ –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å');
}

};
}

function findUserByCard(card){
return Object.keys(names)[0];
}

function pushNotify(title,body){
if(Notification.permission==="granted"){
new Notification(title,{body});
}
}

function toggleHistory(){
historyVisible=!historyVisible;
historyEl.style.display=historyVisible?'block':'none';
}

function getName(e){return names[e]||e;}

function flipCard(){
bankCard.classList.toggle('flipped');
}

async function login(){

const email=emailInput.value.trim();
const password=passwordInput.value.trim();

const r=await fetch(API,{method:'POST',body:JSON.stringify({action:'login',email,password})});
const d=await r.json();

if(!d.success) return alert('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞');

userEmail=email;
balance.textContent=d.balance+' ‚ÇΩ';
cardNumber.textContent=d.card||'0000 0000 0000 0000';

auth.classList.add('hidden');
app.classList.remove('hidden');

if(Notification.permission!=="granted"){
Notification.requestPermission();
}

loadUsers();
loadHistory();
startAutoUpdate();
}

function startAutoUpdate(){

if(autoUpdateInterval) clearInterval(autoUpdateInterval);

autoUpdateInterval=setInterval(async ()=>{
await refreshBalance();
await loadHistory();
},5000);

}

async function refreshBalance(){

const r=await fetch(API,{
method:'POST',
body:JSON.stringify({action:'balance',email:userEmail})
});

const d=await r.json();

if(d.balance!==undefined){
balance.textContent=d.balance+' ‚ÇΩ';
}

}

async function loadUsers(){

to.innerHTML='<option value="">–ü–æ–ª—É—á–∞—Ç–µ–ª—å</option>';

Object.keys(names).filter(e=>e!==userEmail).forEach(e=>{
const o=document.createElement('option');
o.value=e;
o.textContent=getName(e);
to.appendChild(o);
});

}

function addTransactionInstant(toUser,amountVal){

const div=document.createElement('div');
div.className='history-item out';

div.innerHTML=`
<b>–ü–µ—Ä–µ–≤–æ–¥: ${getName(toUser)} ‚Äî ${amountVal} ‚ÇΩ</b><br>
<small>—Ç–æ–ª—å–∫–æ —á—Ç–æ</small>
`;

historyEl.prepend(div);
}

async function transfer(){

const amountVal=Number(amount.value);
if(!to.value||amountVal<=0) return;

addTransactionInstant(to.value,amountVal);

await fetch(API,{
method:'POST',
body:JSON.stringify({
action:'transfer',
from:userEmail,
to:to.value,
amount:amountVal,
comment:comment.value
})
});

await refreshBalance();
await loadHistory();

comment.value='';
amount.value='';
}

async function loadHistory(){

const r=await fetch(API,{
method:'POST',
body:JSON.stringify({action:'history',email:userEmail})
});

const d=await r.json();
const newHistory=d.history||[];

if(lastTxCount!==0 && newHistory.length>lastTxCount){

const newTx=newHistory[0];

const from=newTx[1];
const amountVal=newTx[3];

if(from===userEmail){
pushNotify("üí∏ –°–ø–∏—Å–∞–Ω–∏–µ",`-${amountVal} ‚ÇΩ`);
}else{
pushNotify("üí∞ –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ",`+${amountVal} ‚ÇΩ`);
}

}

lastTxCount=newHistory.length;
lastHistory=newHistory;

historyEl.innerHTML='<h3>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>';

lastHistory.forEach(h=>{

const from=h[1];
const toUser=h[2];
const amountVal=h[3];
const dateVal=new Date(h[0]).toLocaleString();

const type=from===userEmail?'out':'in';

const div=document.createElement('div');
div.className='history-item '+type;

div.innerHTML=`
<b>${type==='out'
?`–ü–µ—Ä–µ–≤–æ–¥: ${getName(toUser)} ‚Äî ${amountVal} ‚ÇΩ`
:`–ó–∞—á–∏—Å–ª–µ–Ω–∏–µ: ${getName(from)} ‚Äî ${amountVal} ‚ÇΩ`
}</b><br>
<small>${dateVal}</small>
`;

historyEl.appendChild(div);
});

}

function downloadStatement(){

let text='–í—ã–ø–∏—Å–∫–∞ PayBank\n\n';

lastHistory.forEach(h=>{
const from=h[1];
const toUser=h[2];
const amountVal=h[3];
const dateVal=new Date(h[0]).toLocaleString();

if(from===userEmail){
text+=`${dateVal} | –ü–µ—Ä–µ–≤–æ–¥ ${getName(toUser)} | ${amountVal} ‚ÇΩ\n`;
}else{
text+=`${dateVal} | –ó–∞—á–∏—Å–ª–µ–Ω–∏–µ ${getName(from)} | ${amountVal} ‚ÇΩ\n`;
}
});

const blob=new Blob([text],{type:'text/plain'});
const a=document.createElement('a');
a.href=URL.createObjectURL(blob);
a.download='paybank_vypiska.txt';
a.click();

}

function logout(){
if(autoUpdateInterval) clearInterval(autoUpdateInterval);
location.reload();
}
</script>

</body>
</html>
