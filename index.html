<script>
    // –í–ê–® URL –∏–∑ —à–∞–≥–∞ 3
    const API_URL = '–í–ê–®_URL_–í–ï–ë_–ü–†–ò–õ–û–ñ–ï–ù–ò–Ø';
    
    let currentUser = null;
    let allUsers = [];
    
    // ========== –í–ê–®–ê GOOGLE FORM ==========
    const GOOGLE_FORM_ID = '1FAIpQLScTjPMG7gOVc1xVXLdRm9_j4aaTn-ZFETokrIRvev11AxteTA';
    
    async function saveToGoogleForm(from, to, amount) {
        try {
            const url = `https://docs.google.com/forms/d/e/${GOOGLE_FORM_ID}/formResponse`;
            const fieldIds = [
                'entry.1361860196', // –û—Ç –∫–æ–≥–æ
                'entry.1065046570', // –ö–æ–º—É  
                'entry.1166974658', // –°—É–º–º–∞
                'entry.839337160'   // –î–∞—Ç–∞
            ];
            
            const formData = new FormData();
            formData.append(fieldIds[0], from);
            formData.append(fieldIds[1], to);
            formData.append(fieldIds[2], amount.toString());
            formData.append(fieldIds[3], new Date().toLocaleDateString('ru-RU'));
            
            await fetch(url, {
                method: 'POST',
                mode: 'no-cors',
                body: formData
            });
            
            console.log('‚úÖ –î–∞–Ω–Ω—ã–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã –≤ Google Form');
            return true;
            
        } catch (error) {
            console.log('‚ö†Ô∏è –û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –≤ Google Form:', error);
            return false;
        }
    }
    
    // ========== –§–£–ù–ö–¶–ò–ò –ë–ê–ù–ö–ê ==========
    
    function showMessage(elementId, text, type) {
        const element = document.getElementById(elementId);
        element.innerHTML = text;
        element.className = `message ${type}`;
        
        if (type !== 'info') {
            setTimeout(() => {
                element.textContent = '';
                element.className = 'message';
            }, 4000);
        }
    }
    
    async function login() {
        const email = document.getElementById('loginEmail').value.toLowerCase().trim();
        const password = document.getElementById('loginPassword').value.trim();
        
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'login',
                    email: email,
                    password: password
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                currentUser = result.user;
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                await loadAllUsers();
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω—ã
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('bankScreen').style.display = 'block';
                document.getElementById('userName').textContent = email;
                document.getElementById('balance').textContent = `${currentUser.balance} ‚Çø`;
                
                showMessage('loginMessage', '‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!', 'success');
                
            } else {
                showMessage('loginMessage', '‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
            }
            
        } catch (error) {
            showMessage('loginMessage', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
        }
    }
    
    async function loadAllUsers() {
        try {
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ action: 'getUsers' })
            });
            
            const result = await response.json();
            allUsers = result.users;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—É—á–∞—Ç–µ–ª–µ–π
            updateRecipientsList();
            
        } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
        }
    }
    
    function updateRecipientsList() {
        const select = document.getElementById('toUser');
        select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</option>';
        
        allUsers.forEach(user => {
            if (user.email !== currentUser.email) {
                const option = document.createElement('option');
                option.value = user.email;
                option.textContent = `${user.email} (${user.balance} ‚Çø)`;
                select.appendChild(option);
            }
        });
    }
    
    async function transfer() {
        if (!currentUser) return;
        
        const toEmail = document.getElementById('toUser').value;
        const amount = parseInt(document.getElementById('amount').value);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∏
        if (!toEmail) {
            showMessage('bankMessage', '‚ùå –í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è', 'error');
            return;
        }
        
        if (!amount || amount <= 0) {
            showMessage('bankMessage', '‚ùå –í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É', 'error');
            return;
        }
        
        if (amount > currentUser.balance) {
            showMessage('bankMessage', `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤! –î–æ—Å—Ç—É–ø–Ω–æ: ${currentUser.balance} ‚Çø`, 'error');
            return;
        }
        
        if (toEmail === currentUser.email) {
            showMessage('bankMessage', '‚ùå –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å —Å–µ–±–µ', 'error');
            return;
        }
        
        try {
            // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –ø–µ—Ä–µ–≤–æ–¥ –Ω–∞ —Å–µ—Ä–≤–µ—Ä
            const response = await fetch(API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    action: 'transfer',
                    fromEmail: currentUser.email,
                    toEmail: toEmail,
                    amount: amount
                })
            });
            
            const result = await response.json();
            
            if (result.success) {
                // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                currentUser.balance = result.newFromBalance;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                await loadAllUsers();
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å –Ω–∞ —ç–∫—Ä–∞–Ω–µ
                document.getElementById('balance').textContent = `${currentUser.balance} ‚Çø`;
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ Google Form
                await saveToGoogleForm(currentUser.email, toEmail, amount);
                
                showMessage('bankMessage', 
                    `‚úÖ –ü–µ—Ä–µ–≤–æ–¥ ${amount} ‚Çø ‚Üí ${toEmail}<br>
                    <small>–ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω —É –≤—Å–µ—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π</small>`, 
                    'success'
                );
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                document.getElementById('amount').value = '';
                document.getElementById('toUser').selectedIndex = 0;
                
            } else {
                showMessage('bankMessage', `‚ùå –û—à–∏–±–∫–∞: ${result.error}`, 'error');
            }
            
        } catch (error) {
            showMessage('bankMessage', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è —Å —Å–µ—Ä–≤–µ—Ä–æ–º', 'error');
            console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:', error);
        }
    }
    
    function logout() {
        currentUser = null;
        allUsers = [];
        document.getElementById('loginScreen').style.display = 'block';
        document.getElementById('bankScreen').style.display = 'none';
        document.getElementById('loginEmail').value = '';
        document.getElementById('loginPassword').value = '';
        document.getElementById('loginMessage').textContent = '';
    }
    
    // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
    window.onload = function() {
        console.log('üè¶ –ë–∞–Ω–∫ –≥–æ—Ç–æ–≤ –∫ —Ä–∞–±–æ—Ç–µ!');
        console.log('API URL:', API_URL);
    };
</script>
