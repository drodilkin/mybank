<!DOCTYPE html>
<html>
<head>
    <title>–ú–æ–π –ë–∞–Ω–∫ (Google Sheets)</title>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 500px; margin: auto; background: #f0f2f5; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .card { background: #e3f2fd; padding: 20px; margin: 15px 0; border-radius: 10px; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #90caf9; }
        button { background: #2196f3; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #1976d2; }
        .balance { font-size: 32px; color: #4caf50; text-align: center; margin: 10px 0; }
        .user-info { display: flex; align-items: center; margin-bottom: 15px; }
        .avatar { width: 50px; height: 50px; background: #2196f3; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 20px; }
        .result { margin-top: 20px; padding: 15px; background: #e8f5e9; border-radius: 8px; border: 1px solid #a5d6a7; display: none; }
        .user-list { background: #f5f5f5; padding: 15px; border-radius: 8px; margin-top: 20px; }
        .error { background: #ffebee; border-color: #ef9a9a; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¶ –ú–æ–π –ë–∞–Ω–∫ (–†–∞–±–æ—Ç–∞–µ—Ç!)</h1>
        
        <div class="card">
            <h3>üîê –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            <input type="email" id="email" placeholder="Email" value="you@test.com">
            <input type="password" id="password" placeholder="–ü–∞—Ä–æ–ª—å" value="123">
            <button onclick="login()">–í–æ–π—Ç–∏ –≤ –±–∞–Ω–∫</button>
            <p style="font-size: 14px; color: #666; margin-top: 10px;">
                –¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:<br>
                ‚Ä¢ you@test.com / 123 (–í—ã)<br>
                ‚Ä¢ friend@test.com / 123 (–î—Ä—É–≥)
            </p>
        </div>
        
        <div id="bank" style="display:none;">
            <div class="user-info">
                <div class="avatar" id="userAvatar">üë§</div>
                <div>
                    <h3 style="margin:0;" id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                    <p style="margin:0; color:#666;" id="userEmail"></p>
                </div>
            </div>
            
            <div class="card">
                <h3>üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å</h3>
                <div class="balance" id="balance">0</div>
                <button onclick="refreshBalance()" style="background: #4caf50;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
            </div>
            
            <div class="card">
                <h3>üì§ –ü–µ—Ä–µ–≤–æ–¥ –¥—Ä—É–≥—É</h3>
                <input type="email" id="friendEmail" placeholder="Email –¥—Ä—É–≥–∞" value="friend@test.com">
                <input type="number" id="amount" placeholder="–°—É–º–º–∞" value="100">
                <button onclick="sendMoney()">üí∏ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–µ–π—á–∞—Å</button>
            </div>
            
            <div class="card">
                <h3>üì± NFC –ö–∞—Ä—Ç–∞</h3>
                <button onclick="checkNFC()">üì≤ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å –ø–æ NFC</button>
            </div>
            
            <div class="user-list">
                <h3>üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</h3>
                <div id="allUsers">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                <button onclick="loadAllUsers()" style="background: #ff9800;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
            </div>
            
            <div id="result" class="result"></div>
            
            <button onclick="logout()" style="background: #f44336;">üö™ –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
        </div>
    </div>

    <script>
        // ========== –ù–ê–°–¢–†–û–ô–ö–ò ==========
        const GOOGLE_SHEET_ID = '1CUB6u5owXML_RulAk6OzoSvZTXTmUdzARzt8UzVyvGI';
        
        let currentUser = null;
        let allUsers = [];
        
        // ========== –ó–ê–ì–†–£–ó–ò–¢–¨ –î–ê–ù–ù–´–ï –ò–ó GOOGLE SHEETS ==========
        async function loadData() {
            console.log('–ó–∞–≥—Ä—É–∂–∞—é –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets...');
            
            try {
                // –§–æ—Ä–º–∏—Ä—É–µ–º URL –¥–ª—è Google Sheets API
                const url = `https://docs.google.com/spreadsheets/d/${GOOGLE_SHEET_ID}/gviz/tq?tqx=out:json`;
                
                // –î–µ–ª–∞–µ–º –∑–∞–ø—Ä–æ—Å
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã');
                }
                
                const text = await response.text();
                const json = JSON.parse(text.substring(47).slice(0, -2));
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ
                allUsers = [];
                const rows = json.table.rows || [];
                
                for (let i = 0; i < rows.length; i++) {
                    const row = rows[i];
                    if (row.c && row.c[0]) {
                        const user = {
                            email: row.c[0]?.v || '',
                            password: row.c[1]?.v || '',
                            name: row.c[2]?.v || '',
                            balance: parseInt(row.c[3]?.v) || 0
                        };
                        if (user.email) {
                            allUsers.push(user);
                        }
                    }
                }
                
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', allUsers.length, allUsers);
                
                // –ï—Å–ª–∏ —Ç–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞—è, —Å–æ–∑–¥–∞–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                if (allUsers.length === 0) {
                    allUsers = [
                        { email: 'you@test.com', password: '123', name: '–í—ã', balance: 1000 },
                        { email: 'friend@test.com', password: '123', name: '–î—Ä—É–≥', balance: 0 }
                    ];
                    console.log('–ò—Å–ø–æ–ª—å–∑—É—é —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π');
                }
                
                return allUsers;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                showResult('‚ö†Ô∏è –ù–µ —É–¥–∞–ª–æ—Å—å –∑–∞–≥—Ä—É–∑–∏—Ç—å –¥–∞–Ω–Ω—ã–µ. –ò—Å–ø–æ–ª—å–∑—É—é –¥–µ–º–æ-—Ä–µ–∂–∏–º.', 'error');
                
                // –î–µ–º–æ-–¥–∞–Ω–Ω—ã–µ
                allUsers = [
                    { email: 'you@test.com', password: '123', name: '–í—ã', balance: 1000 },
                    { email: 'friend@test.com', password: '123', name: '–î—Ä—É–≥', balance: 0 }
                ];
                return allUsers;
            }
        }
        
        // ========== –í–•–û–î –í –°–ò–°–¢–ï–ú–£ ==========
        async function login() {
            const email = document.getElementById('email').value.trim();
            const password = document.getElementById('password').value;
            
            if (!email || !password) {
                showResult('‚ùå –í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }
            
            showResult('‚è≥ –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É...', 'info');
            
            await loadData();
            
            // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const user = allUsers.find(u => 
                u.email.toLowerCase() === email.toLowerCase() && 
                u.password === password
            );
            
            if (user) {
                currentUser = { ...user };
                document.querySelector('.card').style.display = 'none';
                document.getElementById('bank').style.display = 'block';
                document.getElementById('userName').textContent = user.name;
                document.getElementById('userEmail').textContent = user.email;
                document.getElementById('balance').textContent = user.balance + ' –±–∞–ª–ª–æ–≤';
                document.getElementById('userAvatar').textContent = user.name.charAt(0);
                
                showResult(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${user.name}!`, 'success');
                loadAllUsers();
                
            } else {
                showResult('‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
            }
        }
        
        // ========== –ü–ï–†–ï–í–û–î –î–ï–ù–ï–ì ==========
        async function sendMoney() {
            if (!currentUser) {
                showResult('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                return;
            }
            
            const friendEmail = document.getElementById('friendEmail').value.trim();
            const amount = parseInt(document.getElementById('amount').value);
            
            if (!friendEmail || !amount || amount <= 0) {
                showResult('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', 'error');
                return;
            }
            
            if (friendEmail === currentUser.email) {
                showResult('‚ùå –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å —Å–∞–º–æ–º—É —Å–µ–±–µ', 'error');
                return;
            }
            
            await loadData();
            
            // –ù–∞—Ö–æ–¥–∏–º –¥—Ä—É–≥–∞
            const friend = allUsers.find(u => u.email.toLowerCase() === friendEmail.toLowerCase());
            
            if (!friend) {
                showResult('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showResult(`‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –í–∞—à –±–∞–ª–∞–Ω—Å: ${currentUser.balance}`, 'error');
                return;
            }
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã –≤ –ø–∞–º—è—Ç–∏
            currentUser.balance -= amount;
            friend.balance += amount;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –º–∞—Å—Å–∏–≤–µ
            const userIndex = allUsers.findIndex(u => u.email === currentUser.email);
            const friendIndex = allUsers.findIndex(u => u.email === friend.email);
            
            if (userIndex !== -1) allUsers[userIndex].balance = currentUser.balance;
            if (friendIndex !== -1) allUsers[friendIndex].balance = friend.balance;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω–µ
            document.getElementById('balance').textContent = currentUser.balance + ' –±–∞–ª–ª–æ–≤';
            
            // –í –î–ï–ú–û-–†–ï–ñ–ò–ú–ï —Å–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –≤ –ø–∞–º—è—Ç–∏
            // –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Google Sheets –Ω—É–∂–µ–Ω —Å–µ—Ä–≤–µ—Ä
            
            showResult(
                `‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!<br>
                üì§ –í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏: ${amount} –±–∞–ª–ª–æ–≤<br>
                üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å: ${friend.name}<br>
                üí∞ –í–∞—à –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${currentUser.balance} –±–∞–ª–ª–æ–≤<br><br>
                üí° –î—Ä—É–≥ —É–≤–∏–¥–∏—Ç –ø–µ—Ä–µ–≤–æ–¥ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã<br>
                ‚ö†Ô∏è –í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –¥–∞–Ω–Ω—ã–µ –Ω–µ —Å–æ—Ö—Ä–∞–Ω—è—é—Ç—Å—è –≤ —Ç–∞–±–ª–∏—Ü–µ`,
                'success'
            );
            
            loadAllUsers();
        }
        
        // ========== NFC –§–£–ù–ö–¶–ò–Ø ==========
        function checkNFC() {
            if (!currentUser) {
                showResult('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É', 'error');
                return;
            }
            
            showResult(
                `üì± NFC –ö–∞—Ä—Ç–∞:<br>
                üë§ –í–ª–∞–¥–µ–ª–µ—Ü: ${currentUser.name}<br>
                üìß Email: ${currentUser.email}<br>
                üí∞ –ë–∞–ª–∞–Ω—Å: ${currentUser.balance} –±–∞–ª–ª–æ–≤<br><br>
                üéÆ –≠—Ç–æ –¥–µ–º–æ-—Ä–µ–∂–∏–º NFC. –î–ª—è —Ä–µ–∞–ª—å–Ω–æ–≥–æ NFC –Ω—É–∂–µ–Ω Android —Å Chrome.`,
                'info'
            );
        }
        
        // ========== –ó–ê–ì–†–£–ó–ò–¢–¨ –í–°–ï–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ==========
        async function loadAllUsers() {
            await loadData();
            
            let html = '';
            allUsers.forEach(user => {
                const isCurrent = currentUser && user.email === currentUser.email;
                html += `
                    <div style="padding: 10px; margin: 5px 0; background: ${isCurrent ? '#bbdefb' : 'white'}; border-radius: 5px; border: 1px solid #e0e0e0;">
                        <strong>${user.name}</strong> (${user.email})<br>
                        –ë–∞–ª–∞–Ω—Å: <strong>${user.balance} –±–∞–ª–ª–æ–≤</strong>
                        ${isCurrent ? ' ‚Üê —ç—Ç–æ –≤—ã' : ''}
                    </div>
                `;
            });
            
            document.getElementById('allUsers').innerHTML = html || '–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
        }
        
        // ========== –û–ë–ù–û–í–ò–¢–¨ –ë–ê–õ–ê–ù–° ==========
        async function refreshBalance() {
            if (!currentUser) return;
            
            await loadData();
            
            const user = allUsers.find(u => u.email === currentUser.email);
            if (user && user.balance !== currentUser.balance) {
                currentUser.balance = user.balance;
                document.getElementById('balance').textContent = currentUser.balance + ' –±–∞–ª–ª–æ–≤';
                showResult('‚úÖ –ë–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–ª–µ–Ω', 'success');
            } else {
                showResult('–ë–∞–ª–∞–Ω—Å –Ω–µ –∏–∑–º–µ–Ω–∏–ª—Å—è', 'info');
            }
            
            loadAllUsers();
        }
        
        // ========== –ü–û–ö–ê–ó–ê–¢–¨ –†–ï–ó–£–õ–¨–¢–ê–¢ ==========
        function showResult(message, type = 'info') {
            const resultEl = document.getElementById('result');
            resultEl.style.display = 'block';
            resultEl.innerHTML = message;
            
            if (type === 'error') {
                resultEl.style.background = '#ffebee';
                resultEl.style.borderColor = '#ef9a9a';
            } else if (type === 'success') {
                resultEl.style.background = '#e8f5e9';
                resultEl.style.borderColor = '#a5d6a7';
            } else {
                resultEl.style.background = '#e3f2fd';
                resultEl.style.borderColor = '#90caf9';
            }
        }
        
        // ========== –í–´–ô–¢–ò ==========
        function logout() {
            currentUser = null;
            document.getElementById('bank').style.display = 'none';
            document.querySelector('.card').style.display = 'block';
            document.getElementById('result').style.display = 'none';
            document.getElementById('email').value = 'you@test.com';
            document.getElementById('password').value = '123';
        }
        
        // ========== –ê–í–¢–û–ó–ê–ì–†–£–ó–ö–ê –ü–†–ò –°–¢–ê–†–¢–ï ==========
        window.onload = async function() {
            console.log('–°—Ç—Ä–∞–Ω–∏—Ü–∞ –∑–∞–≥—Ä—É–∂–µ–Ω–∞');
            await loadData();
            loadAllUsers();
        };
    </script>
</body>
</html>
