<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MyBank</title>

<style>
:root{
  --bg:#0b0c10;
  --card:#16171d;
  --accent:#ffdd2d;
  --text:#fff;
  --muted:#8e8e93;
  --plus:#2ecc71;
  --minus:#ff4d4f;
}

*{box-sizing:border-box;font-family:Inter,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif}

body{
  margin:0;
  background:radial-gradient(circle at top,#1b1c22,#050507);
  color:var(--text);
  display:flex;
  justify-content:center;
  align-items:center;
  min-height:100vh;
}

.app{
  width:100%;
  max-width:420px;
  height:100vh;
  position:relative;
  overflow:hidden;
}

/* ===== Screens ===== */
.screen{
  position:absolute;
  inset:0;
  padding:24px;
  display:none;
  animation:fade .35s ease;
}
.screen.active{display:block}

@keyframes fade{
  from{opacity:0;transform:translateY(10px)}
  to{opacity:1;transform:translateY(0)}
}

/* ===== UI ===== */
.card{
  background:linear-gradient(180deg,#1b1c22,#121318);
  border-radius:24px;
  padding:24px;
  box-shadow:0 30px 80px rgba(0,0,0,.6);
  margin-bottom:16px;
}

.input{
  width:100%;
  padding:16px;
  margin-top:12px;
  border-radius:16px;
  border:none;
  background:#1f2028;
  color:#fff;
  font-size:16px;
}

.btn{
  width:100%;
  padding:16px;
  margin-top:16px;
  border-radius:18px;
  border:none;
  font-weight:600;
  font-size:16px;
  cursor:pointer;
}

.btn.primary{background:var(--accent);color:#000}
.btn.secondary{background:#1f2028;color:#fff}

/* ===== PIN ===== */
.pin-dots{display:flex;justify-content:center;gap:14px;margin:40px 0}
.dot{width:14px;height:14px;border-radius:50%;background:#2a2b34}
.dot.active{background:var(--accent)}

.pin-pad{display:grid;grid-template-columns:repeat(3,1fr);gap:18px}
.pin-btn{
  height:72px;
  border-radius:50%;
  background:#1f2028;
  border:none;
  font-size:22px;
  color:white;
}
.pin-btn:active{transform:scale(.92)}

/* ===== History ===== */
.history{
  display:flex;
  flex-direction:column;
  gap:12px;
}

.op{
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:#1a1b22;
  padding:14px 16px;
  border-radius:16px;
}

.op.plus{color:var(--plus)}
.op.minus{color:var(--minus)}
.op small{color:var(--muted)}

/* ===== Nav ===== */
.nav{
  position:absolute;
  bottom:0;left:0;right:0;
  height:72px;
  display:flex;
  justify-content:space-around;
  align-items:center;
  backdrop-filter:blur(20px);
  background:rgba(20,20,25,.6);
}
.nav button{
  background:none;border:none;
  color:var(--muted);
  font-size:13px;
}
.nav button.active{color:var(--accent)}
</style>
</head>

<body>
<div class="app">

<!-- LOGIN -->
<div class="screen active" id="login">
  <div class="card">
    <h2>Вход</h2>
    <input class="input" id="email" placeholder="Email">
    <input class="input" id="password" type="password" placeholder="Пароль">
    <button class="btn primary" onclick="login()">Войти</button>
  </div>
</div>

<!-- CREATE PIN -->
<div class="screen" id="createPin">
  <h2>Придумайте PIN</h2>
  <div class="pin-dots" id="createDots"></div>
  <div class="pin-pad" id="createPad"></div>
</div>

<!-- ENTER PIN -->
<div class="screen" id="enterPin">
  <h2>Введите PIN</h2>
  <div class="pin-dots" id="enterDots"></div>
  <div class="pin-pad" id="enterPad"></div>
</div>

<!-- HOME -->
<div class="screen" id="home">
  <div class="card">
    <small>Баланс</small>
    <h1 id="balance">— ₽</h1>
  </div>

  <div class="card">
    <input class="input" id="to" placeholder="Email получателя">
    <input class="input" id="amount" type="number" placeholder="Сумма">
    <button class="btn primary" onclick="transfer()">Перевести</button>
  </div>

  <div class="nav">
    <button class="active" onclick="openTab('home')">Главная</button>
    <button onclick="openTab('history')">История</button>
    <button onclick="logout()">Профиль</button>
  </div>
</div>

<!-- HISTORY -->
<div class="screen" id="history">
  <h2>История операций</h2>
  <div class="history" id="historyList"></div>

  <div class="nav">
    <button onclick="openTab('home')">Главная</button>
    <button class="active">История</button>
    <button onclick="logout()">Профиль</button>
  </div>
</div>

</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwmGrXdDBnlfMM_HWLUSlllbJz_Tyl9HmE3Ii6l0u1IP3u18wF5wdCFuZdjDPl0i4th6g/exec';

/* ===== helpers ===== */
function show(id){
  document.querySelectorAll('.screen').forEach(s=>s.classList.remove('active'));
  document.getElementById(id).classList.add('active');
}
function openTab(id){ show(id); if(id==='history') loadHistory(); }

/* ===== login ===== */
async function login(){
  const email=emailInput.value.trim();
  const password=passwordInput.value.trim();
  const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'login',email,password})});
  const d=await r.json();
  if(!d.success)return alert('Неверные данные');
  localStorage.setItem('email',email);
  localStorage.getItem('pin')?show('enterPin'):show('createPin');
}

/* ===== balance ===== */
async function loadBalance(){
  const email=localStorage.getItem('email');
  const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'balance',email})});
  const d=await r.json();
  balance.textContent=d.balance+' ₽';
}

/* ===== transfer ===== */
async function transfer(){
  const from=localStorage.getItem('email');
  const to=toInput.value.trim();
  const amount=Number(amountInput.value);
  if(!to||amount<=0)return;
  const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'transfer',from,to,amount})});
  const d=await r.json();
  if(!d.success)return alert('Ошибка перевода');
  await loadBalance();
  loadHistory();
  toInput.value='';
  amountInput.value='';
}

/* ===== history ===== */
async function loadHistory(){
  const email=localStorage.getItem('email');
  const r=await fetch(API_URL,{method:'POST',body:JSON.stringify({action:'history',email})});
  const d=await r.json();
  historyList.innerHTML='';
  d.forEach(o=>{
    const div=document.createElement('div');
    const plus=o.to===email;
    div.className='op '+(plus?'plus':'minus');
    div.innerHTML=`<div><small>${plus?'От':'Кому'} ${plus?o.from:o.to}</small></div>
                   <div>${plus?'+':'-'}${o.amount} ₽</div>`;
    historyList.appendChild(div);
  });
}

/* ===== PIN ===== */
function setupPin(dotsId,padId,done){
  let cur='';
  const dots=document.getElementById(dotsId);
  const pad=document.getElementById(padId);
  dots.innerHTML='<div class="dot"></div>'.repeat(4);
  pad.innerHTML='';
  for(let i=1;i<=9;i++)pad.innerHTML+=`<button class="pin-btn">${i}</button>`;
  pad.innerHTML+=`<div></div><button class="pin-btn">0</button><div></div>`;
  pad.querySelectorAll('.pin-btn').forEach(b=>{
    b.onclick=()=>{
      if(cur.length>=4)return;
      cur+=b.textContent;
      dots.children[cur.length-1].classList.add('active');
      if(cur.length===4)done(cur);
    }
  });
}

setupPin('createDots','createPad',async p=>{
  localStorage.setItem('pin',p);
  show('home');
  loadBalance();
});

setupPin('enterDots','enterPad',async p=>{
  if(p===localStorage.getItem('pin')){
    show('home');
    loadBalance();
  }
});

/* ===== logout ===== */
function logout(){
  localStorage.clear();
  show('login');
}

/* ===== start ===== */
window.onload=()=>{
  if(localStorage.getItem('email'))show('enterPin');
}

/* ===== refs ===== */
const emailInput=document.getElementById('email');
const passwordInput=document.getElementById('password');
const balance=document.getElementById('balance');
const toInput=document.getElementById('to');
const amountInput=document.getElementById('amount');
const historyList=document.getElementById('historyList');
</script>
</body>
</html>
