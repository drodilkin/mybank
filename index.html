<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>PayBank</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
--bg:#0b0b10;
--card:#17171f;
--input:#222230;
--accent:#ffd600;
--text:#fff;
--muted:#9b9ba3;
}

*{box-sizing:border-box;font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;}

body{
margin:0;
background:var(--bg);
color:var(--text);
min-height:100vh;
display:flex;
justify-content:center;
align-items:center;
}

.hidden{display:none;}

.auth{background:var(--card);padding:28px;border-radius:22px;width:100%;max-width:360px;}

.auth input,.auth button{
width:100%;
margin-top:12px;
padding:14px;
border:none;
border-radius:14px;
}

.auth input{background:var(--input);color:white;}
.auth button{background:var(--accent);font-weight:600;cursor:pointer;}

.app{width:100%;max-width:420px;padding:16px;}

.card-wrap{perspective:1000px;}

.card{
width:100%;
height:170px;
border-radius:22px;
background:linear-gradient(135deg,#1e1e28,#121218);
padding:20px;
transition:.5s;
transform-style:preserve-3d;
cursor:pointer;
position:relative;
box-shadow:0 0 0 rgba(255,214,0,0);
}

.card:hover{
transform:translateY(-6px);
box-shadow:0 0 25px rgba(255,214,0,0.15);
}

.card.flipped{transform:rotateY(180deg);}

.card-face{
position:absolute;
inset:0;
padding:20px;
backface-visibility:hidden;
}

.card-back{
transform:rotateY(180deg);
display:flex;
flex-direction:column;
justify-content:center;
}

.balance-title{color:var(--muted);}
.balance-amount{font-size:34px;}

.block{background:var(--card);border-radius:22px;padding:18px;margin-top:16px;}

.block input,.block select,.block button{
width:100%;
margin-top:12px;
padding:14px;
border:none;
border-radius:14px;
}

.block input,.block select{background:var(--input);color:white;}
.block button{background:var(--accent);font-weight:600;cursor:pointer;}

.history-item{
padding:12px 0;
border-bottom:1px solid #2a2a36;
opacity:0;
transform:translateY(10px);
animation:fadeIn .35s forwards;
}

@keyframes fadeIn{
to{
opacity:1;
transform:translateY(0);
}
}

.in{color:#2ecc71;}
.out{color:#ff4d4f;}

.logout{background:#2a2a36!important;color:white;}
</style>
</head>

<body>

<div class="auth" id="auth">
<h1>PayBank</h1>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Пароль">
<button onclick="login()">Войти</button>
</div>

<div class="app hidden" id="app">

<div class="card-wrap">
<div class="card" id="bankCard" onclick="flipCard()">
<div class="card-face">
<div class="balance-title">Баланс</div>
<div class="balance-amount" id="balance">0 ₽</div>
</div>

<div class="card-face card-back">
<div class="balance-title">Номер карты</div>
<div class="balance-amount" id="cardNumber"></div>
</div>
</div>
</div>

<div class="block">
<select id="to"></select>
<input id="amount" type="number" placeholder="Сумма">
<input id="comment" placeholder="Комментарий">
<button onclick="transfer()">Перевести</button>
</div>

<div class="block">
<button onclick="downloadStatement()">Скачать выписку</button>
</div>

<div class="block" id="history"></div>

<button class="block logout" onclick="logout()">Выйти</button>

</div>

<script>
const API='https://script.google.com/macros/s/AKfycbyI6e3Eu9FvoH-2kq2iakm92Ceysk-BIB0OEHcbq5golo1lOklgvD_qaVFlYWX2-_Z1bA/exec';

let userEmail='';
let lastHistory=[];
let autoUpdateInterval=null;

const names={
'ilyasvaliev@mail.ru':'Ильяс',
'prokhormart@mail.ru':'Прохор',
'romankisel@mail.ru':'Роман',
'artemant@mail.ru':'Артем'
};

function getName(e){return names[e]||e;}

function flipCard(){
bankCard.classList.toggle('flipped');
}

async function login(){

const email=emailInput.value.trim();
const password=passwordInput.value.trim();

const r=await fetch(API,{method:'POST',body:JSON.stringify({action:'login',email,password})});
const d=await r.json();

if(!d.success) return alert('Ошибка входа');

userEmail=email;
balance.textContent=d.balance+' ₽';
cardNumber.textContent=d.card||'0000 0000 0000 0000';

auth.classList.add('hidden');
app.classList.remove('hidden');

loadUsers();
loadHistory();
startAutoUpdate();
}

function startAutoUpdate(){

if(autoUpdateInterval) clearInterval(autoUpdateInterval);

autoUpdateInterval=setInterval(async ()=>{
await refreshBalance();
await loadHistory();
},5000);

}

async function refreshBalance(){

const r=await fetch(API,{
method:'POST',
body:JSON.stringify({action:'balance',email:userEmail})
});

const d=await r.json();

if(d.balance!==undefined){
balance.textContent=d.balance+' ₽';
}

}

async function loadUsers(){

to.innerHTML='<option value="">Получатель</option>';

Object.keys(names).filter(e=>e!==userEmail).forEach(e=>{
const o=document.createElement('option');
o.value=e;
o.textContent=getName(e);
to.appendChild(o);
});

}

function addTransactionInstant(toUser,amountVal){

const div=document.createElement('div');
div.className='history-item out';

div.innerHTML=`
<b>Перевод: ${getName(toUser)} — ${amountVal} ₽</b><br>
<small>только что</small>
`;

history.prepend(div);
}

async function transfer(){

const amountVal=Number(amount.value);
if(!to.value||amountVal<=0) return;

addTransactionInstant(to.value,amountVal);

const r=await fetch(API,{
method:'POST',
body:JSON.stringify({
action:'transfer',
from:userEmail,
to:to.value,
amount:amountVal,
comment:comment.value
})
});

await refreshBalance();
await loadHistory();

comment.value='';
amount.value='';

}

async function loadHistory(){

const r=await fetch(API,{
method:'POST',
body:JSON.stringify({action:'history',email:userEmail})
});

const d=await r.json();
lastHistory=d.history||[];

history.innerHTML='<h3>История операций</h3>';

lastHistory.forEach(h=>{

const from=h[1];
const toUser=h[2];
const amountVal=h[3];
const dateVal=new Date(h[0]).toLocaleString();

const type=from===userEmail?'out':'in';

const div=document.createElement('div');
div.className='history-item '+type;

div.innerHTML=`
<b>${type==='out'
?`Перевод: ${getName(toUser)} — ${amountVal} ₽`
:`Зачисление: ${getName(from)} — ${amountVal} ₽`
}</b><br>
<small>${dateVal}</small>
`;

history.appendChild(div);
});

}

function downloadStatement(){

let text='Выписка PayBank\n\n';

lastHistory.forEach(h=>{
const from=h[1];
const toUser=h[2];
const amountVal=h[3];
const dateVal=new Date(h[0]).toLocaleString();

if(from===userEmail){
text+=`${dateVal} | Перевод ${getName(toUser)} | ${amountVal} ₽\n`;
}else{
text+=`${dateVal} | Зачисление ${getName(from)} | ${amountVal} ₽\n`;
}
});

const blob=new Blob([text],{type:'text/plain'});
const a=document.createElement('a');
a.href=URL.createObjectURL(blob);
a.download='paybank_vypiska.txt';
a.click();

}

function logout(){
if(autoUpdateInterval) clearInterval(autoUpdateInterval);
location.reload();
}

const emailInput=document.getElementById('email');
const passwordInput=document.getElementById('password');
</script>

</body>
</html>
