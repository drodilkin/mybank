<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>PayBank</title>

<style>

*{box-sizing:border-box}

body{
margin:0;
font-family:Inter,Arial;
background:#0b0b0b;
color:white;
display:flex;
justify-content:center;
}

.app{
width:100%;
max-width:430px;
padding:15px;
}

.card{
background:#171717;
border-radius:22px;
padding:20px;
margin-top:15px;
box-shadow:0 0 25px #000;
}

h1{
margin:0;
text-align:center;
}

input{
width:100%;
padding:15px;
margin-top:10px;
border-radius:14px;
border:none;
background:#262626;
color:white;
font-size:16px;
}

button{
width:100%;
padding:15px;
margin-top:12px;
border-radius:14px;
border:none;
background:#ffd400;
font-weight:bold;
font-size:16px;
cursor:pointer;
}

.smallbtn{
background:#333;
color:white;
}

.balance{
font-size:34px;
font-weight:bold;
margin-top:10px;
}

.row{
display:flex;
gap:10px;
}

.row button{
flex:1;
}

.history{
margin-top:10px;
}

.tx{
background:#222;
padding:10px;
border-radius:12px;
margin-top:8px;
font-size:14px;
}

.err{
background:#3a1414;
padding:12px;
border-radius:12px;
margin-top:10px;
display:none;
}

.loader{
display:none;
text-align:center;
margin-top:10px;
}

</style>
</head>

<body>

<div class="app">

<!-- LOGIN -->
<div id="login" class="card">
<h1>PayBank</h1>
<input id="email" placeholder="Email">
<input id="password" type="password" placeholder="Пароль">
<button onclick="login()">Войти</button>
<div id="err" class="err">Неверные данные</div>
<div id="load" class="loader">Загрузка...</div>
</div>

<!-- BANK -->
<div id="bank" style="display:none">

<div class="card">
<div>Баланс</div>
<div id="balance" class="balance">0₽</div>
<div>Карта: <span id="card"></span></div>

<div class="row">
<button class="smallbtn" onclick="loadHistory()">История</button>
<button class="smallbtn" onclick="logout()">Выйти</button>
</div>

</div>

<div class="card">
<h3>Перевод</h3>
<input id="toCard" placeholder="Карта получателя">
<input id="amount" type="number" placeholder="Сумма">
<button onclick="transfer()">Отправить</button>
</div>

<div class="card">
<h3>История операций</h3>
<div id="history" class="history"></div>
</div>

</div>

</div>

<script>

const API="https://script.google.com/macros/s/AKfycbwHcb10OvHfl5VNABPVgTCL50fPM0uG3Qk7BZLUQUo8cLCcN8xZeDMHIZp7D5MDo8gDKQ/exec";
let user=null;

function showLoader(v){
document.getElementById("load").style.display=v?"block":"none";
}

function showError(v){
document.getElementById("err").style.display=v?"block":"none";
}

async function api(data){

const r=await fetch(API,{
method:"POST",
body:JSON.stringify(data)
});

return await r.json();
}

async function login(){

showLoader(true);
showError(false);

const email=document.getElementById("email").value;
const password=document.getElementById("password").value;

const res=await api({
action:"login",
email,
password
});

showLoader(false);

if(!res.ok){
showError(true);
return;
}

user=res;
localStorage.setItem("user",JSON.stringify(res));

openBank();
}

function openBank(){

document.getElementById("login").style.display="none";
document.getElementById("bank").style.display="block";

updateUI();
loadHistory();
}

function updateUI(){

document.getElementById("balance").innerText=
Number(user.balance).toLocaleString()+" ₽";

document.getElementById("card").innerText=user.card;

}

async function transfer(){

const card=document.getElementById("toCard").value;
const amount=document.getElementById("amount").value;

const res=await api({
action:"transfer",
from:user.email,
card,
amount
});

if(res.ok){

user.balance-=Number(amount);
localStorage.setItem("user",JSON.stringify(user));
updateUI();
loadHistory();

alert("Перевод выполнен");

}else{
alert("Ошибка перевода");
}
}

async function loadHistory(){

const res=await api({
action:"history",
email:user.email
});

const h=document.getElementById("history");
h.innerHTML="";

if(!res.list) return;

res.list.reverse().forEach(tx=>{

h.innerHTML+=`
<div class="tx">
${tx.date}<br>
${tx.from} → ${tx.to}<br>
${tx.amount} ₽
</div>
`;

});
}

function logout(){
localStorage.removeItem("user");
location.reload();
}

window.onload=()=>{

const saved=localStorage.getItem("user");

if(saved){
user=JSON.parse(saved);
openBank();
}

};

</script>

</body>
</html>
