<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>PROFIT PLATINUM</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --y: #ffd600; --bg: #050508; --glass: rgba(255, 255, 255, 0.03); }
        body { 
            margin:0; background: var(--bg); color:#fff; font-family:'Inter'; height:100vh; overflow:hidden;
            background: radial-gradient(circle at 0% 0%, #1a1a2e 0%, #050508 50%);
        }

        /* КРАСИВЫЙ ВХОД */
        .auth-overlay {
            position: fixed; inset: 0; display: flex; flex-direction: column; justify-content: center;
            align-items: center; padding: 30px; z-index: 100; transition: 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            background: var(--bg);
        }
        .auth-overlay.hide { opacity: 0; transform: scale(1.2); pointer-events: none; }

        .login-box {
            width: 100%; max-width: 380px; padding: 40px 30px; border-radius: 40px;
            background: rgba(20, 20, 30, 0.6); backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 214, 0, 0.15); text-align: center;
            box-shadow: 0 25px 50px rgba(0,0,0,0.8);
        }
        
        .logo-anim { font-family:'Orbitron'; font-size: 32px; font-weight: 900; color: var(--y); text-shadow: 0 0 20px rgba(255,214,0,0.4); margin-bottom: 40px; }

        .input-group { position: relative; margin-bottom: 20px; }
        input { 
            width: 100%; padding: 20px; background: rgba(0,0,0,0.4); border: 1px solid rgba(255,255,255,0.05);
            border-radius: 20px; color: #fff; font-size: 16px; transition: 0.4s; box-sizing: border-box;
        }
        input:focus { border-color: var(--y); background: rgba(0,0,0,0.6); outline: none; box-shadow: 0 0 15px rgba(255,214,0,0.1); }

        .btn-glow {
            width: 100%; padding: 22px; background: var(--y); border: none; border-radius: 20px;
            font-family: 'Orbitron'; font-weight: 900; color: #000; cursor: pointer;
            text-transform: uppercase; letter-spacing: 2px; transition: 0.3s;
            box-shadow: 0 10px 20px rgba(255,214,0,0.2);
        }
        .btn-glow:active { transform: scale(0.96); filter: brightness(1.2); }

        /* ОСНОВНОЙ ЭКРАН */
        .app { height:100vh; display:flex; flex-direction:column; padding: 20px; }
        .card-view {
            background: linear-gradient(135deg, #1e1e30 0%, #08080c 100%);
            border-radius: 35px; padding: 30px; border: 1px solid rgba(255,255,255,0.08);
            margin-bottom: 25px; position: relative; overflow: hidden;
        }
        .card-view::after { content:''; position:absolute; top:-50%; left:-50%; width:200%; height:200%; background: radial-gradient(circle, rgba(255,214,0,0.05) 0%, transparent 70%); }
        
        .bal-val { font-family:'Orbitron'; font-size: 44px; font-weight: 900; margin: 15px 0; transition: 0.5s; }
        
        /* ИСТОРИЯ */
        .hist-container { flex: 1; overflow-y: auto; padding-right: 5px; }
        .hist-item { 
            background: var(--glass); padding: 18px; border-radius: 22px; margin-bottom: 12px;
            border: 1px solid rgba(255,255,255,0.03); display: flex; justify-content: space-between; align-items: center;
        }
        .amt-plus { color: #00ffaa; font-weight: 800; }
        .amt-minus { color: #ff3366; font-weight: 800; }

        /* NFC ТАБ */
        .nfc-circle {
            width: 220px; height: 220px; border-radius: 50%; border: 2px solid var(--y);
            margin: 40px auto; display: flex; align-items: center; justify-content: center;
            position: relative; box-shadow: 0 0 30px rgba(255,214,0,0.1);
        }
        .nfc-pulse { position: absolute; inset: -10px; border: 2px solid var(--y); border-radius: 50%; opacity: 0; animation: pulse 2s infinite; }
        @keyframes pulse { 0% { transform: scale(1); opacity: 0.5; } 100% { transform: scale(1.3); opacity: 0; } }

        .tabs-nav { display: flex; gap: 10px; background: var(--panel); padding: 10px; border-radius: 30px; margin-top: auto; }
        .tab-btn { flex: 1; padding: 15px; border-radius: 20px; border: none; background: transparent; color: #555; font-weight: 800; font-size: 11px; }
        .tab-btn.active { background: var(--y); color: #000; }

        .hidden { display: none; }
    </style>
</head>
<body>

<div id="authScreen" class="auth-overlay">
    <div class="login-box">
        <div class="logo-anim">PROFIT</div>
        <div class="input-group">
            <input type="email" id="email" placeholder="Email Address">
        </div>
        <div class="input-group">
            <input type="password" id="pass" placeholder="Password">
        </div>
        <button class="btn-glow" onclick="handleLogin()">Login</button>
        <p style="margin-top:20px; font-size:12px; color:#555;">SECURITY ENCRYPTED 256-BIT</p>
    </div>
</div>

<div id="app" class="app hidden">
    <div class="card-view">
        <div style="font-size:11px; color:#666; letter-spacing:2px; font-weight:700;">TOTAL BALANCE</div>
        <div id="mainBal" class="bal-val">0 ₽</div>
        <div id="userEmail" style="color:var(--y); font-size:12px; font-weight:800;">USER@MAIL.RU</div>
    </div>

    <div id="nfcTab" class="tab-content">
        <div class="nfc-circle">
            <div class="nfc-pulse"></div>
            <div style="font-family:'Orbitron'; color:var(--y); text-align:center;">
                <span style="font-size:24px;">NFC</span><br><span style="font-size:10px;">READY</span>
            </div>
        </div>
        <button class="btn-glow" onclick="bindTag()" style="background:transparent; border:1px solid var(--y); color:var(--y);">Привязать NFC метку</button>
    </div>

    <div id="histTab" class="tab-content hidden">
        <h3 style="font-family:'Orbitron'; font-size:16px; color:var(--y); margin-bottom:20px;">TRANSACTIONS</h3>
        <div id="histItems" class="hist-container"></div>
    </div>

    <div class="tabs-nav">
        <button class="tab-btn active" onclick="switchTab('nfc', this)">NFC PAY</button>
        <button class="tab-btn" onclick="switchTab('hist', this)">HISTORY</button>
    </div>
</div>

<script>
const API_URL = 'https://script.google.com/macros/s/AKfycbwbNz4G8l-Kqx2gyTyoDZ75mc249_MUGwDIYjENPr0iCUL34ENSBzJ_A212b5A61iFExQ/exec';
let currentUser = null;
let oldBal = 0;

async function handleLogin() {
    const email = document.getElementById('email').value;
    const pass = document.getElementById('pass').value;
    
    const res = await fetch(API_URL, {method:'POST', body: JSON.stringify({action:'login', email, pass})});
    const d = await res.json();
    
    if(d.success) {
        currentUser = { email, ...d };
        document.getElementById('authScreen').classList.add('hide');
        setTimeout(() => {
            document.getElementById('app').classList.remove('hidden');
            sync();
            setInterval(sync, 4000);
            startNFCListener();
        }, 600);
    } else alert("Invalid Credentials");
}

function animateValue(newVal) {
    const el = document.getElementById('mainBal');
    if (newVal === oldBal) return;
    
    let start = oldBal;
    const duration = 1000;
    let startTime = null;

    function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / duration, 1);
        const current = Math.floor(progress * (newVal - start) + start);
        el.innerText = current.toLocaleString() + ' ₽';
        el.style.color = newVal > start ? '#00ffaa' : '#ff3366';
        if (progress < 1) {
            window.requestAnimationFrame(step);
        } else {
            el.style.color = '#fff';
            oldBal = newVal;
        }
    }
    window.requestAnimationFrame(step);
}

async function sync() {
    const res = await fetch(API_URL, {method:'POST', body: JSON.stringify({action:'sync', email: currentUser.email})});
    const d = await res.json();
    animateValue(d.bal);
    document.getElementById('userEmail').innerText = currentUser.email.toUpperCase();
    
    document.getElementById('histItems').innerHTML = d.history.map(h => `
        <div class="hist-item">
            <div>
                <div style="font-size:14px; font-weight:700;">${h[1] === currentUser.email ? 'Transfer' : 'Received'}</div>
                <div style="font-size:10px; color:#555;">${h[4]}</div>
            </div>
            <div class="${h[1] === currentUser.email ? 'amt-minus' : 'amt-plus'}">
                ${h[1] === currentUser.email ? '-' : '+'}${h[3]} ₽
            </div>
        </div>
    `).join('');
}

function switchTab(t, b) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById(t + 'Tab').classList.remove('hidden');
    document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
    b.classList.add('active');
}

// NFC ЛОГИКА
async function startNFCListener() {
    if ('NDEFReader' in window) {
        const ndef = new NDEFReader();
        await ndef.scan();
        ndef.onreading = async ({ serialNumber }) => {
            const amt = prompt("Сумма списания с метки:", "100");
            if (!amt) return;
            const res = await fetch(API_URL, {method:'POST', body: JSON.stringify({
                action: 'nfc_pay', tagId: serialNumber, receiverEmail: currentUser.email, amount: amt
            })});
            const d = await res.json();
            if(d.success) alert("Оплата прошла!"); else alert(d.msg);
            sync();
        };
    }
}

async function bindTag() {
    alert("Подносите NFC метку для привязки...");
    const ndef = new NDEFReader();
    await ndef.scan();
    ndef.onreading = async ({ serialNumber }) => {
        await fetch(API_URL, {method:'POST', body: JSON.stringify({action:'bind_nfc', email: currentUser.email, tagId: serialNumber})});
        alert("Метка привязана!");
    };
}
</script>
</body>
</html>
