<!DOCTYPE html>
<html>
<head>
    <title>–ú–æ–π –ë–∞–Ω–∫</title>
    <style>
        body { font-family: Arial; max-width: 500px; margin: auto; padding: 20px; background: #f5f7fa; }
        .container { background: white; padding: 25px; border-radius: 15px; box-shadow: 0 5px 20px rgba(0,0,0,0.1); }
        h1 { text-align: center; color: #333; margin-bottom: 25px; }
        .card { background: #f8fafc; padding: 20px; margin: 15px 0; border-radius: 10px; border-left: 4px solid #3b82f6; }
        input, button { width: 100%; padding: 14px; margin: 10px 0; border-radius: 8px; border: 1px solid #ddd; font-size: 16px; }
        button { background: #3b82f6; color: white; border: none; cursor: pointer; font-weight: bold; }
        button:hover { background: #2563eb; }
        .balance { font-size: 32px; color: #10b981; font-weight: bold; text-align: center; margin: 15px 0; }
        .user-info { display: flex; align-items: center; margin-bottom: 20px; }
        .avatar { width: 50px; height: 50px; background: #3b82f6; border-radius: 50%; margin-right: 15px; display: flex; align-items: center; justify-content: center; color: white; font-size: 24px; }
        .result { margin-top: 20px; padding: 15px; background: #dbeafe; border-radius: 8px; border: 1px solid #93c5fd; display: none; }
        .tab { display: flex; margin-bottom: 20px; }
        .tab button { flex: 1; margin: 0 5px; background: #e2e8f0; color: #4a5568; }
        .tab button.active { background: #3b82f6; color: white; }
        .users-list { background: #f1f5f9; padding: 15px; border-radius: 8px; margin-top: 20px; }
    </style>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º Supabase -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
</head>
<body>
    <div class="container">
        <h1>üè¶ –ú–æ–π –ë–∞–Ω–∫ (Supabase)</h1>
        
        <div class="tab">
            <button class="tab-btn active" onclick="showTab('login')">–í—Ö–æ–¥</button>
            <button class="tab-btn" onclick="showTab('register')">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</button>
        </div>
        
        <!-- –í–•–û–î -->
        <div id="login-tab" class="tab-content">
            <div class="card">
                <h3>üîê –í–æ–π—Ç–∏ –≤ –∞–∫–∫–∞—É–Ω—Ç</h3>
                <input type="email" id="login-email" placeholder="–í–∞—à email" value="you@test.com">
                <input type="password" id="login-password" placeholder="–ü–∞—Ä–æ–ª—å" value="123">
                <button onclick="login()">–í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É</button>
            </div>
        </div>
        
        <!-- –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø -->
        <div id="register-tab" class="tab-content" style="display:none;">
            <div class="card">
                <h3>üìù –°–æ–∑–¥–∞—Ç—å –∞–∫–∫–∞—É–Ω—Ç</h3>
                <input type="text" id="reg-name" placeholder="–í–∞—à–µ –∏–º—è">
                <input type="email" id="reg-email" placeholder="Email">
                <input type="password" id="reg-password" placeholder="–ü–∞—Ä–æ–ª—å">
                <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            </div>
        </div>
        
        <!-- –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ -->
        <div id="dashboard" style="display:none;">
            <div class="user-info">
                <div class="avatar" id="userAvatar">üë§</div>
                <div>
                    <h3 style="margin:0;" id="userName">–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å</h3>
                    <p style="margin:0; color:#666;" id="userEmail">email@test.com</p>
                </div>
            </div>
            
            <div class="card">
                <h3>üí∞ –í–∞—à –±–∞–ª–∞–Ω—Å</h3>
                <div class="balance" id="balance">0</div>
            </div>
            
            <div class="card">
                <h3>üì§ –ü–µ—Ä–µ–≤–æ–¥ –¥—Ä—É–≥—É</h3>
                <input type="email" id="friend-email" placeholder="Email –¥—Ä—É–≥–∞" value="friend@test.com">
                <input type="number" id="amount" placeholder="–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞" value="100">
                <button onclick="sendMoney()">üí∏ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–µ–π—á–∞—Å</button>
            </div>
            
            <div class="card">
                <h3>üì± NFC –ö–∞—Ä—Ç–∞</h3>
                <p style="color:#666;">–î–µ–º–æ NFC —Ñ—É–Ω–∫—Ü–∏—è</p>
                <button onclick="checkNFC()">üì≤ –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –±–∞–ª–∞–Ω—Å</button>
            </div>
            
            <div class="users-list">
                <h3>üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏ (–æ–±–Ω–æ–≤–ª—è–µ—Ç—Å—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏):</h3>
                <div id="allUsers">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            </div>
            
            <div class="result" id="result"></div>
            
            <div style="text-align:center; margin-top:20px;">
                <button onclick="logout()" style="background:#ef4444;">üö™ –í—ã–π—Ç–∏</button>
            </div>
        </div>
    </div>

    <script>
        // ==================== –í–°–¢–ê–í–¨ –°–í–û–ò –ö–õ–Æ–ß–ò SUPABASE –ó–î–ï–°–¨! ====================
        // –ü–æ–ª—É—á–∏ –∏—Ö –≤ Supabase: Settings ‚Üí API ‚Üí Project URL –∏ anon public
        const SUPABASE_URL = 'https://–í–ê–®-ID.supabase.co';  // ‚Üê –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô URL
        const SUPABASE_KEY = '—Ç–≤–æ–π-anon-public-key';         // ‚Üê –ó–ê–ú–ï–ù–ò –ù–ê –°–í–û–ô –ö–õ–Æ–ß
        // =========================================================================
        
        // –°–æ–∑–¥–∞–µ–º –∫–ª–∏–µ–Ω—Ç Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        
        // ==================== –í–ö–õ–ê–î–ö–ò ====================
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.tab-btn').forEach(el => {
                el.classList.remove('active');
            });
            
            document.getElementById(tabName + '-tab').style.display = 'block';
            event.target.classList.add('active');
        }
        
        // ==================== –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø ====================
        async function register() {
            const name = document.getElementById('reg-name').value;
            const email = document.getElementById('reg-email').value;
            const password = document.getElementById('reg-password').value;
            
            if (!name || !email || !password) {
                showResult('‚ùå –ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!', 'error');
                return;
            }
            
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º, –Ω–µ—Ç –ª–∏ —É–∂–µ —Ç–∞–∫–æ–≥–æ email
            const { data: existingUser } = await supabase
                .from('users')
                .select('*')
                .eq('email', email)
                .single();
            
            if (existingUser) {
                showResult('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å —Å —Ç–∞–∫–∏–º email —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç', 'error');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –Ω–æ–≤–æ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const { data, error } = await supabase
                .from('users')
                .insert([{ 
                    name: name, 
                    email: email, 
                    password: password,
                    balance: 1000  // –ù–∞—á–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å
                }])
                .select()
                .single();
            
            if (error) {
                showResult('‚ùå –û—à–∏–±–∫–∞: ' + error.message, 'error');
            } else {
                showResult('‚úÖ –ê–∫–∫–∞—É–Ω—Ç —Å–æ–∑–¥–∞–Ω! –¢–µ–ø–µ—Ä—å –≤–æ–π–¥–∏—Ç–µ.', 'success');
                showTab('login');
                loadAllUsers(); // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            }
        }
        
        // ==================== –í–•–û–î ====================
        async function login() {
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            
            const { data, error } = await supabase
                .from('users')
                .select('*')
                .eq('email', email)
                .eq('password', password)
                .single();
            
            if (error || !data) {
                showResult('‚ùå –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }
            
            currentUser = data;
            showDashboard();
            showResult(`‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ${data.name}!`, 'success');
            loadAllUsers(); // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ –±–∞–∑–µ
            subscribeToUpdates();
        }
        
        // ==================== –õ–ò–ß–ù–´–ô –ö–ê–ë–ò–ù–ï–¢ ====================
        function showDashboard() {
            document.querySelectorAll('.tab-content').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.display = 'none';
            });
            
            document.getElementById('dashboard').style.display = 'block';
            
            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('userEmail').textContent = currentUser.email;
            document.getElementById('balance').textContent = currentUser.balance + ' –±–∞–ª–ª–æ–≤';
            document.getElementById('userAvatar').textContent = currentUser.name.charAt(0);
        }
        
        // ==================== –ü–ï–†–ï–í–û–î –î–ï–ù–ï–ì ====================
        async function sendMoney() {
            const friendEmail = document.getElementById('friend-email').value;
            const amount = parseInt(document.getElementById('amount').value);
            
            if (!friendEmail || !amount || amount <= 0) {
                showResult('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showResult('‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤!', 'error');
                return;
            }
            
            // –ù–∞–π—Ç–∏ –ø–æ–ª—É—á–∞—Ç–µ–ª—è
            const { data: friend, error: findError } = await supabase
                .from('users')
                .select('*')
                .eq('email', friendEmail)
                .single();
            
            if (findError || !friend) {
                showResult('‚ùå –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            if (friend.id === currentUser.id) {
                showResult('‚ùå –ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–µ—Å—Ç–∏ —Å–∞–º–æ–º—É —Å–µ–±–µ', 'error');
                return;
            }
            
            // –û–±–Ω–æ–≤–∏—Ç—å –±–∞–ª–∞–Ω—Å—ã –≤ Supabase
            const newMyBalance = currentUser.balance - amount;
            const newFriendBalance = friend.balance + amount;
            
            // –ù–∞—á–∏–Ω–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            const { error: updateMyError } = await supabase
                .from('users')
                .update({ balance: newMyBalance })
                .eq('id', currentUser.id);
            
            const { error: updateFriendError } = await supabase
                .from('users')
                .update({ balance: newFriendBalance })
                .eq('id', friend.id);
            
            if (updateMyError || updateFriendError) {
                showResult('‚ùå –û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞', 'error');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º –∑–∞–ø–∏—Å—å –æ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏
            await supabase
                .from('transactions')
                .insert([{
                    from_user: currentUser.id,
                    to_user: friend.id,
                    amount: amount,
                    from_name: currentUser.name,
                    to_name: friend.name
                }]);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            currentUser.balance = newMyBalance;
            document.getElementById('balance').textContent = newMyBalance + ' –±–∞–ª–ª–æ–≤';
            
            showResult(
                `‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!<br>
                üì§ –í—ã –æ—Ç–ø—Ä–∞–≤–∏–ª–∏: ${amount} –±–∞–ª–ª–æ–≤<br>
                üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å: ${friend.name}<br>
                üí∞ –í–∞—à –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ${newMyBalance} –±–∞–ª–ª–æ–≤`,
                'success'
            );
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            loadAllUsers();
        }
        
        // ==================== NFC –§–£–ù–ö–¶–ò–Ø ====================
        async function checkNFC() {
            showResult(
                `üì± –ë–∞–ª–∞–Ω—Å –ø–æ NFC:<br>
                üë§ –í–ª–∞–¥–µ–ª–µ—Ü: ${currentUser.name}<br>
                üí∞ –ë–∞–ª–∞–Ω—Å: ${currentUser.balance} –±–∞–ª–ª–æ–≤<br>
                üìß Email: ${currentUser.email}`,
                'info'
            );
        }
        
        // ==================== –ó–ê–ì–†–£–ó–ò–¢–¨ –í–°–ï–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ====================
        async function loadAllUsers() {
            const { data: users, error } = await supabase
                .from('users')
                .select('*')
                .order('balance', { ascending: false });
            
            if (error) {
                document.getElementById('allUsers').innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
                return;
            }
            
            let html = '';
            users.forEach(user => {
                html += `
                    <div style="padding: 8px; border-bottom: 1px solid #ddd;">
                        <strong>${user.name}</strong> (${user.email})<br>
                        –ë–∞–ª–∞–Ω—Å: <strong>${user.balance} –±–∞–ª–ª–æ–≤</strong>
                    </div>
                `;
            });
            
            document.getElementById('allUsers').innerHTML = html;
        }
        
        // ==================== –ü–û–î–ü–ò–°–ö–ê –ù–ê –û–ë–ù–û–í–õ–ï–ù–ò–Ø ====================
        function subscribeToUpdates() {
            // –ü–æ–¥–ø–∏—Å—ã–≤–∞–µ–º—Å—è –Ω–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è –≤ —Ç–∞–±–ª–∏—Ü–µ users
            supabase
                .channel('users-changes')
                .on('postgres_changes', 
                    { event: '*', schema: 'public', table: 'users' }, 
                    () => {
                        // –ü—Ä–∏ –ª—é–±—ã—Ö –∏–∑–º–µ–Ω–µ–Ω–∏—è—Ö –æ–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏ –±–∞–ª–∞–Ω—Å
                        loadAllUsers();
                        
                        // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                        if (currentUser) {
                            supabase
                                .from('users')
                                .select('balance')
                                .eq('id', currentUser.id)
                                .single()
                                .then(({ data }) => {
                                    if (data && data.balance !== currentUser.balance) {
                                        currentUser.balance = data.balance;
                                        document.getElementById('balance').textContent = data.balance + ' –±–∞–ª–ª–æ–≤';
                                    }
                                });
                        }
                    }
                )
                .subscribe();
        }
        
        // ==================== –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò ====================
        function showResult(message, type) {
            const resultEl = document.getElementById('result');
            resultEl.style.display = 'block';
            resultEl.innerHTML = message;
            resultEl.style.background = type === 'error' ? '#fee2e2' : 
                                      type === 'info' ? '#dbeafe' : 
                                      '#d1fae5';
            resultEl.style.borderColor = type === 'error' ? '#f87171' : 
                                       type === 'info' ? '#93c5fd' : 
                                       '#a7f3d0';
        }
        
        function logout() {
            currentUser = null;
            document.getElementById('dashboard').style.display = 'none';
            document.querySelectorAll('.tab-content').forEach(el => {
                el.style.display = 'none';
            });
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.style.display = 'flex';
            });
            document.getElementById('login-tab').style.display = 'block';
        }
        
        // ==================== –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ====================
        document.addEventListener('DOMContentLoaded', function() {
            // –ü—Ä–æ–≤–µ—Ä—è–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Å Supabase
            supabase
                .from('users')
                .select('count', { count: 'exact', head: true })
                .then(response => {
                    console.log('Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω!');
                    loadAllUsers(); // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π —Å—Ä–∞–∑—É
                })
                .catch(error => {
                    console.error('–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è –∫ Supabase:', error);
                    document.getElementById('allUsers').innerHTML = 
                        '‚ùå –ù–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ –∫ –±–∞–∑–µ –¥–∞–Ω–Ω—ã—Ö. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ –∫–ª—é—á–∏ Supabase.';
                });
        });
    </script>
</body>
</html>
