<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 { color: #333; margin-bottom: 30px; text-align: center; }
        .tab-container { margin-bottom: 20px; }
        .tab { 
            display: inline-block; 
            padding: 10px 20px; 
            cursor: pointer; 
            background: #f0f0f0;
            margin-right: 5px;
            border-radius: 5px 5px 0 0;
        }
        .tab.active { background: white; font-weight: bold; }
        .tab-content { 
            display: none; 
            padding: 20px; 
            border: 1px solid #f0f0f0;
            border-radius: 0 0 5px 5px;
        }
        .tab-content.active { display: block; }
        input { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        button { 
            width: 100%; 
            padding: 14px; 
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white; 
            border: none; 
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin-top: 10px;
        }
        .balance { 
            font-size: 24px; 
            text-align: center; 
            margin: 20px 0;
            color: #28a745;
            font-weight: bold;
        }
        .message { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            text-align: center;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .logout-btn {
            background: #dc3545 !important;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¶ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫</h1>
        
        <div class="tab-container">
            <div class="tab active" onclick="showTab('login')" id="loginTab">–í—Ö–æ–¥</div>
            <div class="tab" onclick="showTab('register')" id="registerTab">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</div>
            <div class="tab" onclick="showTab('bank')" id="bankTab" style="display:none">–ë–∞–Ω–∫</div>
            <div class="tab" onclick="showTab('history')" id="historyTab" style="display:none">–ò—Å—Ç–æ—Ä–∏—è</div>
        </div>
        
        <!-- –í—Ö–æ–¥ -->
        <div class="tab-content active" id="login">
            <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            <input type="email" id="loginEmail" placeholder="Email" value="test@mail.ru">
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" value="12345">
            <button onclick="login()">–í–æ–π—Ç–∏</button>
            <div class="message info">
                –¢–µ—Å—Ç–æ–≤—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:<br>
                test@mail.ru / 12345<br>
                user@mail.ru / 54321
            </div>
            <div id="loginMessage" class="message"></div>
        </div>
        
        <!-- –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è -->
        <div class="tab-content" id="register">
            <h3>–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h3>
            <input type="email" id="regEmail" placeholder="Email">
            <input type="password" id="regPassword" placeholder="–ü–∞—Ä–æ–ª—å (–º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞)">
            <button onclick="register()">–ó–∞—Ä–µ–≥–∏—Å—Ç—Ä–∏—Ä–æ–≤–∞—Ç—å—Å—è</button>
            <div id="regMessage" class="message"></div>
        </div>
        
        <!-- –ë–∞–Ω–∫ -->
        <div class="tab-content" id="bank">
            <h3>–í–∞—à –≤–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π —Å—á—ë—Ç</h3>
            <div class="balance" id="balance">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            
            <h4>–ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h4>
            <input type="email" id="sendTo" placeholder="Email –ø–æ–ª—É—á–∞—Ç–µ–ª—è">
            <input type="number" id="sendAmount" placeholder="–°—É–º–º–∞ (‚Çø)" min="1">
            <button onclick="sendMoney()">–û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
            
            <h4>–ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ–≤–æ–¥</h4>
            <button onclick="quickSend('user@mail.ru', 100)" style="background:#28a745">–û—Ç–ø—Ä–∞–≤–∏—Ç—å 100 ‚Çø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é user@mail.ru</button>
            
            <button onclick="logout()" class="logout-btn">–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
            <div id="bankMessage" class="message"></div>
        </div>
        
        <!-- –ò—Å—Ç–æ—Ä–∏—è -->
        <div class="tab-content" id="history">
            <h3>–ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h3>
            <button onclick="loadHistory()">–û–±–Ω–æ–≤–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é</button>
            <div id="historyList" style="margin-top:15px; max-height:300px; overflow-y:auto;"></div>
        </div>
    </div>

    <script>
        // –í–ê–®–ò –î–ê–ù–ù–´–ï
        const SHEET_ID = '1UJzb281UvBZIGr9rE8y0hzvhHUt_G2YDnRYqlTi03xI';
        const API_KEY = 'AIzaSyDv5GBoJW60bPwuGOroiVF1r9WokT4zQX0';
        
        let currentUser = null;
        
        // –ü–æ–∫–∞–∑–∞—Ç—å –≤–∫–ª–∞–¥–∫—É
        function showTab(tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            document.getElementById(tabName).classList.add('active');
            document.getElementById(tabName + 'Tab').classList.add('active');
        }
        
        // –í–æ–π—Ç–∏
        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;
            
            try {
                // –ü—Ä–æ–±—É–µ–º –ø–æ–ª—É—á–∏—Ç—å –¥–∞–Ω–Ω—ã–µ –∏–∑ Google Sheets
                const users = await getUsersFromSheet();
                
                // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                const user = users.find(u => 
                    u.Email && u.Email.toLowerCase() === email.toLowerCase() && 
                    u.Password === password
                );
                
                if (user) {
                    currentUser = {
                        id: user.ID,
                        email: user.Email,
                        balance: parseInt(user.Balance) || 0
                    };
                    
                    document.getElementById('loginMessage').innerHTML = '–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥!';
                    document.getElementById('loginMessage').className = 'message success';
                    
                    // –ü–æ–∫–∞–∑–∞—Ç—å –±–∞–Ω–∫–æ–≤—Å–∫–∏–µ –≤–∫–ª–∞–¥–∫–∏
                    document.getElementById('bankTab').style.display = 'inline-block';
                    document.getElementById('historyTab').style.display = 'inline-block';
                    document.getElementById('loginTab').style.display = 'none';
                    document.getElementById('registerTab').style.display = 'none';
                    
                    // –ü–µ—Ä–µ–π—Ç–∏ –≤ –±–∞–Ω–∫
                    showTab('bank');
                    updateBalanceDisplay();
                    
                } else {
                    document.getElementById('loginMessage').innerHTML = '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                    document.getElementById('loginMessage').className = 'message error';
                }
                
            } catch (error) {
                console.log('–û—à–∏–±–∫–∞ Google Sheets, –∏—Å–ø–æ–ª—å–∑—É–µ–º –ª–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ');
                // –õ–æ–∫–∞–ª—å–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –¥–ª—è —Ç–µ—Å—Ç–∞
                const localUsers = [
                    {ID: '1', Email: 'test@mail.ru', Password: '12345', Balance: '1000'},
                    {ID: '2', Email: 'user@mail.ru', Password: '54321', Balance: '500'}
                ];
                
                const user = localUsers.find(u => 
                    u.Email.toLowerCase() === email.toLowerCase() && 
                    u.Password === password
                );
                
                if (user) {
                    currentUser = {
                        id: user.ID,
                        email: user.Email,
                        balance: parseInt(user.Balance)
                    };
                    
                    document.getElementById('loginMessage').innerHTML = '–£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥ (–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º)!';
                    document.getElementById('loginMessage').className = 'message success';
                    
                    document.getElementById('bankTab').style.display = 'inline-block';
                    document.getElementById('historyTab').style.display = 'inline-block';
                    document.getElementById('loginTab').style.display = 'none';
                    document.getElementById('registerTab').style.display = 'none';
                    
                    showTab('bank');
                    updateBalanceDisplay();
                } else {
                    document.getElementById('loginMessage').innerHTML = '–ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å';
                    document.getElementById('loginMessage').className = 'message error';
                }
            }
        }
        
        // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è (—É–ø—Ä–æ—â–µ–Ω–Ω–∞—è)
        function register() {
            const email = document.getElementById('regEmail').value.trim();
            const password = document.getElementById('regPassword').value;
            
            if (!email || !password) {
                showMessage('regMessage', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            if (password.length < 4) {
                showMessage('regMessage', '–ü–∞—Ä–æ–ª—å –º–∏–Ω–∏–º—É–º 4 —Å–∏–º–≤–æ–ª–∞', 'error');
                return;
            }
            
            // –õ–æ–∫–∞–ª—å–Ω–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            alert('–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –≤ –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ. –í–æ–π–¥–∏—Ç–µ –∫–∞–∫ test@mail.ru / 12345');
            
            document.getElementById('regEmail').value = '';
            document.getElementById('regPassword').value = '';
            setTimeout(() => showTab('login'), 1000);
        }
        
        // –û—Ç–ø—Ä–∞–≤–∏—Ç—å –¥–µ–Ω—å–≥–∏
        async function sendMoney() {
            if (!currentUser) return;
            
            const toEmail = document.getElementById('sendTo').value.trim();
            const amount = parseInt(document.getElementById('sendAmount').value);
            
            if (!toEmail || !amount || amount <= 0) {
                showMessage('bankMessage', '–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è', 'error');
                return;
            }
            
            if (amount > currentUser.balance) {
                showMessage('bankMessage', `–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –í–∞—à –±–∞–ª–∞–Ω—Å: ${currentUser.balance} ‚Çø`, 'error');
                return;
            }
            
            try {
                // –ü–æ–ª—É—á–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                const users = await getUsersFromSheet();
                const receiver = users.find(u => 
                    u.Email && u.Email.toLowerCase() === toEmail.toLowerCase()
                );
                
                if (!receiver) {
                    showMessage('bankMessage', '–ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                    return;
                }
                
                if (receiver.Email === currentUser.email) {
                    showMessage('bankMessage', '–ù–µ–ª—å–∑—è –ø–µ—Ä–µ–≤–æ–¥–∏—Ç—å —Å–µ–±–µ', 'error');
                    return;
                }
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã (–¥–µ–º–æ-–≤–µ—Ä—Å–∏—è)
                currentUser.balance -= amount;
                
                // –î–æ–±–∞–≤–ª—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
                await addTransaction(currentUser.id, receiver.ID, amount);
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
                updateBalanceDisplay();
                
                showMessage('bankMessage', 
                    `‚úÖ –ü–µ—Ä–µ–≤–æ–¥ ${amount} ‚Çø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${toEmail} –≤—ã–ø–æ–ª–Ω–µ–Ω!<br>
                    <small>–î–µ–º–æ-—Ä–µ–∂–∏–º: –±–∞–ª–∞–Ω—Å –æ–±–Ω–æ–≤–∏–ª—Å—è –ª–æ–∫–∞–ª—å–Ω–æ</small>`, 
                    'success'
                );
                
                // –û—á–∏—â–∞–µ–º –ø–æ–ª—è
                document.getElementById('sendTo').value = '';
                document.getElementById('sendAmount').value = '';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞:', error);
                // –õ–æ–∫–∞–ª—å–Ω—ã–π –¥–µ–º–æ-—Ä–µ–∂–∏–º
                currentUser.balance -= amount;
                updateBalanceDisplay();
                
                showMessage('bankMessage', 
                    `‚úÖ –î–µ–º–æ-–ø–µ—Ä–µ–≤–æ–¥ ${amount} ‚Çø –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—é ${toEmail}<br>
                    <small>(–ª–æ–∫–∞–ª—å–Ω—ã–π —Ä–µ–∂–∏–º)</small>`, 
                    'success'
                );
            }
        }
        
        // –ë—ã—Å—Ç—Ä—ã–π –ø–µ—Ä–µ–≤–æ–¥
        function quickSend(email, amount) {
            document.getElementById('sendTo').value = email;
            document.getElementById('sendAmount').value = amount;
            sendMoney();
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
        async function loadHistory() {
            const historyDiv = document.getElementById('historyList');
            historyDiv.innerHTML = '<p>–ó–∞–≥—Ä—É–∑–∫–∞ –∏—Å—Ç–æ—Ä–∏–∏...</p>';
            
            try {
                const transactions = await getTransactionsFromSheet();
                const users = await getUsersFromSheet();
                
                if (transactions.length === 0) {
                    historyDiv.innerHTML = '<p>–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</p>';
                    return;
                }
                
                let html = '';
                transactions.forEach(trans => {
                    const fromUser = users.find(u => u.ID === trans.FromID);
                    const toUser = users.find(u => u.ID === trans.ToID);
                    
                    html += `
                        <div style="padding:10px; border-bottom:1px solid #eee; margin:5px 0">
                            <div><strong>${fromUser?.Email || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'} ‚Üí ${toUser?.Email || '–ù–µ–∏–∑–≤–µ—Å—Ç–Ω–æ'}</strong></div>
                            <div>–°—É–º–º–∞: ${trans.Amount} ‚Çø</div>
                            <div><small>${trans.Date || '–î–∞—Ç–∞ –Ω–µ —É–∫–∞–∑–∞–Ω–∞'}</small></div>
                        </div>
                    `;
                });
                
                historyDiv.innerHTML = html;
                
            } catch (error) {
                historyDiv.innerHTML = '<p>–ò—Å—Ç–æ—Ä–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π –ø—É—Å—Ç–∞ –∏–ª–∏ –æ—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏</p>';
            }
        }
        
        // –í—ã–π—Ç–∏
        function logout() {
            currentUser = null;
            document.getElementById('bankTab').style.display = 'none';
            document.getElementById('historyTab').style.display = 'none';
            document.getElementById('loginTab').style.display = 'inline-block';
            document.getElementById('registerTab').style.display = 'inline-block';
            
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            
            showTab('login');
        }
        
        // –û–±–Ω–æ–≤–∏—Ç—å –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –±–∞–ª–∞–Ω—Å–∞
        function updateBalanceDisplay() {
            if (currentUser) {
                document.getElementById('balance').innerHTML = `${currentUser.balance} ‚Çø`;
            }
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = text;
            element.className = `message ${type}`;
        }
        
        // ========== GOOGLE SHEETS –§–£–ù–ö–¶–ò–ò ==========
        
        // –ü–æ–ª—É—á–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
        async function getUsersFromSheet() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Users`;
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substr(47).slice(0, -2));
                
                if (!json.table || !json.table.rows) return [];
                
                const headers = json.table.cols.map(col => col.label);
                return json.table.rows.map(row => {
                    const obj = {};
                    row.c.forEach((cell, index) => {
                        obj[headers[index]] = cell ? cell.v : '';
                    });
                    return obj;
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                throw error;
            }
        }
        
        // –ü–æ–ª—É—á–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ –∏–∑ —Ç–∞–±–ª–∏—Ü—ã
        async function getTransactionsFromSheet() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Transactions`;
                const response = await fetch(url);
                const text = await response.text();
                const json = JSON.parse(text.substr(47).slice(0, -2));
                
                if (!json.table || !json.table.rows) return [];
                
                const headers = json.table.cols.map(col => col.label);
                return json.table.rows.map(row => {
                    const obj = {};
                    row.c.forEach((cell, index) => {
                        obj[headers[index]] = cell ? cell.v : '';
                    });
                    return obj;
                });
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–π:', error);
                return []; // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –ø—É—Å—Ç–æ–π –º–∞—Å—Å–∏–≤ –µ—Å–ª–∏ –ª–∏—Å—Ç–∞ –Ω–µ—Ç
            }
        }
        
        // –î–æ–±–∞–≤–∏—Ç—å —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
        async function addTransaction(fromId, toId, amount) {
            try {
                // –≠—Ç–æ—Ç –º–µ—Ç–æ–¥ —Ç—Ä–µ–±—É–µ—Ç –±–æ–ª–µ–µ —Å–ª–æ–∂–Ω–æ–π –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ API
                // –í –¥–µ–º–æ-—Ä–µ–∂–∏–º–µ –ø—Ä–æ—Å—Ç–æ –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                console.log(`–î–æ–±–∞–≤–ª–µ–Ω–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—è: ${fromId} ‚Üí ${toId}, —Å—É–º–º–∞: ${amount}`);
                return true;
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏:', error);
                return false;
            }
        }
        
        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            showTab('login');
        };
    </script>
</body>
</html>
