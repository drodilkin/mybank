<!DOCTYPE html>
<html>
<head>
    <title>–ú–æ–π –ë–∞–Ω–∫</title>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <style>
        body { font-family: Arial; padding: 20px; max-width: 500px; margin: auto; }
        .card { background: #e3f2fd; padding: 20px; margin: 15px 0; border-radius: 10px; }
        input, button { width: 100%; padding: 12px; margin: 8px 0; border-radius: 8px; border: 1px solid #90caf9; }
        button { background: #1976d2; color: white; border: none; cursor: pointer; }
        .balance { font-size: 32px; color: #2e7d32; text-align: center; margin: 10px 0; }
    </style>
</head>
<body>
    <h1>üè¶ –ú–æ–π –ë–∞–Ω–∫</h1>
    
    <div class="card">
        <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É:</h3>
        <input id="email" placeholder="Email" value="you@test.com">
        <input id="password" type="password" placeholder="–ü–∞—Ä–æ–ª—å" value="123">
        <button onclick="login()">–í–æ–π—Ç–∏</button>
        <p style="font-size: 14px; color: #666; margin-top: 10px;">
            –¢–µ—Å—Ç–æ–≤—ã–µ –ª–æ–≥–∏–Ω—ã:<br>
            ‚Ä¢ you@test.com / 123 (–í—ã)<br>
            ‚Ä¢ friend@test.com / 123 (–î—Ä—É–≥)
        </p>
    </div>
    
    <div id="bank" style="display:none;">
        <div class="card">
            <h3>üë§ <span id="userName"></span></h3>
            <div class="balance">üí∞ <span id="balance">0</span> –±–∞–ª–ª–æ–≤</div>
            <p style="text-align: center; color: #666;" id="userEmail"></p>
        </div>
        
        <div class="card">
            <h3>üì§ –ü–µ—Ä–µ–≤–æ–¥ –¥—Ä—É–≥—É:</h3>
            <input id="friendEmail" placeholder="Email –¥—Ä—É–≥–∞" value="friend@test.com">
            <input id="amount" type="number" placeholder="–°—É–º–º–∞" value="100">
            <button onclick="sendMoney()">üí∏ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏</button>
        </div>
        
        <div class="card">
            <h3>üë• –í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</h3>
            <div id="allUsers">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
            <button onclick="loadUsers()" style="background: #388e3c;">üîÑ –û–±–Ω–æ–≤–∏—Ç—å —Å–ø–∏—Å–æ–∫</button>
        </div>
        
        <div id="result" class="card" style="background: #e8f5e9; display:none;"></div>
        
        <button onclick="logout()" style="background: #d32f2f;">–í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
    </div>

    <script>
        // ========== –¢–í–û–ò –ö–õ–Æ–ß–ò SUPABASE ==========
        const SUPABASE_URL = 'https://jxhyktvwjcpqoelxduoz.supabase.co';
        const SUPABASE_KEY = 'sb_publishable_dk0dKz62B_kuH-gA7KIlnQ_SEK5K5Am';
        // =========================================
        
        // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –∫ Supabase
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_KEY);
        
        let currentUser = null;
        
        // –ü—Ä–æ–≤–µ—Ä—è–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        console.log('Supabase –ø–æ–¥–∫–ª—é—á–µ–Ω:', !!supabase);
        
        // ========== –§–£–ù–ö–¶–ò–Ø –í–•–û–î–ê ==========
        async function login() {
            console.log('–ü—ã—Ç–∞—é—Å—å –≤–æ–π—Ç–∏...');
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∑–∞–≥—Ä—É–∑–∫—É
            document.getElementById('result').style.display = 'block';
            document.getElementById('result').innerHTML = '‚è≥ –í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É...';
            
            try {
                // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –≤ –±–∞–∑–µ
                const { data, error } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', email)
                    .eq('password', password)
                    .single();
                
                if (error) {
                    console.error('–û—à–∏–±–∫–∞ Supabase:', error);
                    throw new Error('–û—à–∏–±–∫–∞ –±–∞–∑—ã –¥–∞–Ω–Ω—ã—Ö: ' + error.message);
                }
                
                if (!data) {
                    throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –ø–∞—Ä–æ–ª—å');
                }
                
                // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                currentUser = data;
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –ª–∏—á–Ω—ã–π –∫–∞–±–∏–Ω–µ—Ç
                document.querySelector('.card').style.display = 'none';
                document.getElementById('bank').style.display = 'block';
                document.getElementById('userName').textContent = data.name;
                document.getElementById('userEmail').textContent = data.email;
                document.getElementById('balance').textContent = data.balance + ' –±–∞–ª–ª–æ–≤';
                
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                showResult('‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, ' + data.name + '!');
                
                // –ó–∞–≥—Ä—É–∂–∞–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                loadUsers();
                
                console.log('–í—Ö–æ–¥ —É—Å–ø–µ—à–µ–Ω:', data);
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –≤—Ö–æ–¥–∞:', error);
                showResult('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // ========== –§–£–ù–ö–¶–ò–Ø –ü–ï–†–ï–í–û–î–ê ==========
        async function sendMoney() {
            console.log('–ù–∞—á–∏–Ω–∞—é –ø–µ—Ä–µ–≤–æ–¥...');
            const friendEmail = document.getElementById('friendEmail').value;
            const amount = parseInt(document.getElementById('amount').value);
            
            if (!amount || amount <= 0) {
                showResult('‚ùå –í–≤–µ–¥–∏—Ç–µ –∫–æ—Ä—Ä–µ–∫—Ç–Ω—É—é —Å—É–º–º—É');
                return;
            }
            
            if (!currentUser) {
                showResult('‚ùå –°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É');
                return;
            }
            
            showResult('‚è≥ –í—ã–ø–æ–ª–Ω—è—é –ø–µ—Ä–µ–≤–æ–¥...');
            
            try {
                // 1. –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                const { data: friend, error: friendError } = await supabase
                    .from('users')
                    .select('*')
                    .eq('email', friendEmail)
                    .single();
                
                if (friendError || !friend) {
                    throw new Error('–ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ' + friendEmail + ' –Ω–µ –Ω–∞–π–¥–µ–Ω');
                }
                
                // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –ª–∏ –¥–µ–Ω–µ–≥
                if (amount > currentUser.balance) {
                    throw new Error('–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤. –í–∞—à –±–∞–ª–∞–Ω—Å: ' + currentUser.balance);
                }
                
                // 3. –í—ã–ø–æ–ª–Ω—è–µ–º –ø–µ—Ä–µ–≤–æ–¥ (–æ–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã)
                const newMyBalance = currentUser.balance - amount;
                const newFriendBalance = friend.balance + amount;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–ø—Ä–∞–≤–∏—Ç–µ–ª—è
                const { error: updateMyError } = await supabase
                    .from('users')
                    .update({ balance: newMyBalance })
                    .eq('id', currentUser.id);
                
                if (updateMyError) throw updateMyError;
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è
                const { error: updateFriendError } = await supabase
                    .from('users')
                    .update({ balance: newFriendBalance })
                    .eq('id', friend.id);
                
                if (updateFriendError) throw updateFriendError;
                
                // 4. –û–±–Ω–æ–≤–ª—è–µ–º —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
                currentUser.balance = newMyBalance;
                document.getElementById('balance').textContent = newMyBalance + ' –±–∞–ª–ª–æ–≤';
                
                // 5. –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É—Å–ø–µ—Ö
                showResult(
                    '‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!<br>' +
                    'üì§ –û—Ç–ø—Ä–∞–≤–∏–ª–∏: ' + amount + ' –±–∞–ª–ª–æ–≤<br>' +
                    'üë§ –ü–æ–ª—É—á–∞—Ç–µ–ª—å: ' + friend.name + '<br>' +
                    'üí∞ –í–∞—à –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: ' + newMyBalance + ' –±–∞–ª–ª–æ–≤<br><br>' +
                    'üí° –î—Ä—É–≥ —É–≤–∏–¥–∏—Ç –ø–µ—Ä–µ–≤–æ–¥ –ø–æ—Å–ª–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç—Ä–∞–Ω–∏—Ü—ã'
                );
                
                // 6. –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                loadUsers();
                
                console.log('–ü–µ—Ä–µ–≤–æ–¥ —É—Å–ø–µ—à–µ–Ω:', { amount, to: friend.name });
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –ø–µ—Ä–µ–≤–æ–¥–∞:', error);
                showResult('‚ùå –û—à–∏–±–∫–∞: ' + error.message);
            }
        }
        
        // ========== –ó–ê–ì–†–£–ó–ò–¢–¨ –í–°–ï–• –ü–û–õ–¨–ó–û–í–ê–¢–ï–õ–ï–ô ==========
        async function loadUsers() {
            try {
                const { data: users, error } = await supabase
                    .from('users')
                    .select('*')
                    .order('balance', { ascending: false });
                
                if (error) throw error;
                
                let html = '';
                users.forEach(user => {
                    const isCurrent = currentUser && user.id === currentUser.id;
                    html += `
                        <div style="padding: 10px; margin: 5px 0; background: ${isCurrent ? '#bbdefb' : 'white'}; border-radius: 5px;">
                            <strong>${user.name}</strong> (${user.email})<br>
                            –ë–∞–ª–∞–Ω—Å: <strong>${user.balance} –±–∞–ª–ª–æ–≤</strong>
                            ${isCurrent ? ' ‚Üê —ç—Ç–æ –≤—ã' : ''}
                        </div>
                    `;
                });
                
                document.getElementById('allUsers').innerHTML = html || '–ù–µ—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π';
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π:', error);
                document.getElementById('allUsers').innerHTML = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏';
            }
        }
        
        // ========== –ü–û–ö–ê–ó–ê–¢–¨ –†–ï–ó–£–õ–¨–¢–ê–¢ ==========
        function showResult(message) {
            const result = document.getElementById('result');
            result.style.display = 'block';
            result.innerHTML = message;
        }
        
        // ========== –í–´–ô–¢–ò ==========
        function logout() {
            currentUser = null;
            document.getElementById('bank').style.display = 'none';
            document.querySelector('.card').style.display = 'block';
            document.getElementById('email').value = 'you@test.com';
            document.getElementById('password').value = '123';
            document.getElementById('result').style.display = 'none';
            console.log('–í—ã—à–ª–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã');
        }
        
        // –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –∑–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = function() {
            loadUsers();
        };
    </script>
</body>
</html>
