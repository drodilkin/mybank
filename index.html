<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROFIT BANK | PREMIUM EDITION</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #ffd600;
            --accent-dim: #bfa100;
            --bg: #050508;
            --card: #11111a;
            --panel: #181824;
            --text: #ffffff;
            --muted: #8e8e9d;
            --success: #00ffa3;
            --error: #ff2d60;
            --glass: rgba(255, 255, 255, 0.03);
            --border: rgba(255, 255, 255, 0.08);
            --shadow: 0 20px 50px rgba(0,0,0,0.8);
        }

        /* –ì–ª–æ–±–∞–ª—å–Ω—ã–µ —Å—Ç–∏–ª–∏ */
        * { box-sizing: border-box; font-family: 'Inter', sans-serif; -webkit-tap-highlight-color: transparent; }
        body { 
            margin: 0; background: var(--bg); color: var(--text); overflow-x: hidden; 
            background-image: radial-gradient(circle at 50% -20%, #1e1e2e 0%, #050508 100%);
            min-height: 100vh;
        }

        .hidden { display: none !important; }

        /* --- –ê–ù–ò–ú–ê–¶–ò–ò --- */
        @keyframes fadeIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes rotateLoader { to { transform: rotate(360deg); } }
        @keyframes pulse { 0% { transform: scale(1); opacity: 1; } 50% { transform: scale(1.05); opacity: 0.7; } 100% { transform: scale(1); opacity: 1; } }
        @keyframes slideRight { from { transform: translateX(-20px); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
        @keyframes gradientFlow { 0% { background-position: 0% 50%; } 50% { background-position: 100% 50%; } 100% { background-position: 0% 50%; } }

        /* --- –°–ö–ê–ù–ï–† –ü–†–ò –ü–ï–†–ï–í–û–î–ï --- */
        #procOverlay {
            position: fixed; inset: 0; background: rgba(0,0,0,0.98); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            opacity: 0; pointer-events: none; transition: 0.6s cubic-bezier(0.4, 0, 0.2, 1);
        }
        #procOverlay.active { opacity: 1; pointer-events: auto; }
        
        .loader-ring {
            width: 150px; height: 150px; border-radius: 50%;
            border: 2px solid var(--glass); border-top: 2px solid var(--accent);
            animation: rotateLoader 1s linear infinite; position: relative;
        }
        .loader-ring::before {
            content: "PROFIT"; position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%); font-family: 'Orbitron'; font-weight: 900; color: var(--accent);
        }

        /* --- –ò–ù–¢–ï–†–§–ï–ô–° --- */
        .container { width: 100%; max-width: 450px; margin: 0 auto; padding: 25px 15px; animation: fadeIn 0.8s ease; }

        /* –ö–ê–†–¢–ê */
        .card-container { perspective: 1200px; height: 240px; margin-bottom: 35px; }
        .card-main {
            width: 100%; height: 100%; position: relative;
            transform-style: preserve-3d; transition: transform 0.8s cubic-bezier(0.34, 1.56, 0.64, 1);
        }
        .card-main.is-flipped { transform: rotateY(180deg); }

        .card-front, .card-back {
            position: absolute; inset: 0; border-radius: 32px; padding: 30px;
            backface-visibility: hidden; -webkit-backface-visibility: hidden;
            border: 1px solid var(--border); box-shadow: var(--shadow);
            background: linear-gradient(135deg, #1c1c2b 0%, #0a0a0f 100%);
            display: flex; flex-direction: column; justify-content: space-between;
        }

        .card-back { transform: rotateY(180deg); background: #0c0c12; align-items: center; justify-content: center; }

        .chip { width: 45px; height: 35px; background: linear-gradient(135deg, #ffd600 0%, #9c8400 100%); border-radius: 8px; margin-bottom: 10px; opacity: 0.8; }
        .balance-box { cursor: pointer; }
        .balance-title { font-size: 10px; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); margin-bottom: 5px; }
        .balance-num { font-size: 40px; font-weight: 900; letter-spacing: -1px; }

        .ava-frame {
            width: 75px; height: 75px; border-radius: 50%; border: 3px solid var(--accent);
            padding: 3px; background: var(--bg); box-shadow: 0 0 20px var(--accent-glow);
        }
        .ava-frame img { width: 100%; height: 100%; border-radius: 50%; object-fit: cover; }

        /* –ù–ê–í–ò–ì–ê–¶–ò–Ø */
        .dock {
            display: flex; gap: 8px; background: var(--card); padding: 8px;
            border-radius: 24px; border: 1px solid var(--border); margin-bottom: 30px;
        }
        .dock-item {
            flex: 1; padding: 14px 5px; border: none; background: none;
            color: var(--muted); font-size: 10px; font-weight: 800;
            cursor: pointer; border-radius: 18px; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .dock-item.active { background: var(--accent); color: #000; box-shadow: 0 10px 20px rgba(255,214,0,0.2); }

        /* –°–ï–ö–¶–ò–ò */
        .content-section {
            background: var(--card); border-radius: 35px; padding: 30px;
            border: 1px solid var(--border); margin-bottom: 25px;
            animation: fadeIn 0.5s ease-out; box-shadow: var(--shadow);
        }
        h2 { font-size: 22px; font-weight: 900; margin: 0 0 25px; color: var(--accent); display: flex; align-items: center; gap: 10px; }

        /* –ü–û–õ–Ø –í–í–û–î–ê */
        .input-group { margin-bottom: 20px; }
        .input-group label { display: block; font-size: 10px; font-weight: 800; color: var(--muted); margin: 0 0 8px 15px; text-transform: uppercase; }
        
        input, select {
            width: 100%; padding: 20px 25px; background: var(--panel);
            border: 1px solid var(--border); border-radius: 22px;
            color: #fff; font-size: 16px; font-weight: 600; transition: 0.3s;
        }
        input:focus { border-color: var(--accent); background: #20202e; outline: none; box-shadow: 0 0 15px var(--accent-glow); }

        .btn-action {
            width: 100%; padding: 22px; background: var(--accent);
            border: none; border-radius: 22px; font-weight: 900;
            font-size: 16px; color: #000; cursor: pointer;
            transition: 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            text-transform: uppercase; letter-spacing: 1px;
        }
        .btn-action:active { transform: scale(0.95); }

        /* –ß–ê–¢ */
        #chatView { height: 400px; overflow-y: auto; display: flex; flex-direction: column-reverse; gap: 15px; padding-right: 10px; }
        .bubble { display: flex; gap: 12px; max-width: 85%; align-items: flex-end; animation: slideRight 0.3s ease; }
        .bubble.me { align-self: flex-end; flex-direction: row-reverse; text-align: right; }
        .bubble-msg { background: var(--panel); padding: 14px 18px; border-radius: 22px 22px 22px 5px; }
        .bubble.me .bubble-msg { background: var(--accent); color: #000; border-radius: 22px 22px 5px 22px; font-weight: 500; }
        .bubble-info { font-size: 10px; font-weight: 800; opacity: 0.5; margin-bottom: 4px; display: block; text-transform: uppercase; }

        /* –ò–°–¢–û–†–ò–Ø */
        .hist-card {
            display: flex; align-items: center; gap: 15px; padding: 20px;
            background: rgba(255,255,255,0.02); border-radius: 25px; margin-bottom: 12px;
            border-left: 4px solid transparent; transition: 0.3s;
        }
        .hist-card:hover { background: rgba(255,255,255,0.05); transform: translateX(5px); }
        .icon-box { width: 45px; height: 45px; border-radius: 15px; display: flex; align-items: center; justify-content: center; font-size: 20px; }

        /* –ü–†–û–§–ò–õ–¨ –ò –ê–ù–ê–õ–ò–¢–ò–ö–ê */
        .stats-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-top: 20px; }
        .stat-item { background: var(--panel); padding: 20px; border-radius: 25px; text-align: center; border: 1px solid var(--border); }
        .stat-val { display: block; font-size: 20px; font-weight: 900; color: var(--accent); }
        .stat-label { font-size: 10px; color: var(--muted); text-transform: uppercase; margin-top: 5px; }

        .progress-container { margin: 25px 0; }
        .progress-bar { height: 10px; background: #222; border-radius: 5px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, var(--accent), var(--success)); width: 75%; box-shadow: 0 0 15px var(--accent-glow); }

        /* –≠–ö–†–ê–ù –í–•–û–î–ê */
        #loginScreen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 25px; }
        .login-box { 
            background: var(--card); padding: 45px 35px; border-radius: 40px; 
            width: 100%; max-width: 400px; text-align: center; border: 1px solid var(--border);
            box-shadow: 0 40px 100px rgba(0,0,0,0.6);
        }

    </style>
</head>
<body>

    <div id="procOverlay">
        <div class="loader-ring"></div>
        <h2 id="procTitle" style="margin-top: 30px; letter-spacing: 3px;">–ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø...</h2>
        <p style="color: var(--muted); font-size: 12px; font-family: 'JetBrains Mono';">–ë–ª–æ–∫—á–µ–π–Ω-–≤–µ—Ä–∏—Ñ–∏–∫–∞—Ü–∏—è —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏</p>
    </div>

    <div id="loginScreen">
        <div class="login-box">
            <div style="font-family:'Orbitron'; font-size:35px; font-weight:900; color:var(--accent); margin-bottom:10px;">PROFIT</div>
            <p style="color:var(--muted); font-size:12px; letter-spacing:3px; margin-bottom:40px;">PRIVATE BANKING SYSTEM</p>
            
            <div class="input-group">
                <input type="email" id="logEmail" placeholder="ID –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è (Email)">
            </div>
            <div class="input-group">
                <input type="password" id="logPass" placeholder="–ú–∞—Å—Ç–µ—Ä-–∫–ª—é—á">
            </div>
            <button class="btn-action" onclick="handleLogin()">–í–û–ô–¢–ò –í –°–ò–°–¢–ï–ú–£</button>
            <div id="loginError" style="color:var(--error); font-size:12px; margin-top:20px; font-weight:700; display:none;">–û–®–ò–ë–ö–ê –î–û–°–¢–£–ü–ê: –ü–†–û–í–ï–†–¨–¢–ï –î–ê–ù–ù–´–ï</div>
        </div>
    </div>

    <div id="mainApp" class="container hidden">
        
        <div class="card-container">
            <div class="card-main" id="cardElement" onclick="this.classList.toggle('is-flipped')">
                <div class="card-front">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div class="chip"></div>
                        <div class="ava-frame"><img id="userAva" src=""></div>
                    </div>
                    <div class="balance-box" onclick="toggleBalance(event)">
                        <div class="balance-title">–¢–µ–∫—É—â–∏–π –±–∞–ª–∞–Ω—Å</div>
                        <div class="balance-num" id="userBalDisplay">0.00 ‚ÇΩ</div>
                        <div id="userNameDisplay" style="margin-top:15px; font-weight:800; font-size:15px; text-transform:uppercase; letter-spacing:1px;">...</div>
                    </div>
                </div>
                <div class="card-back">
                    <div class="balance-title">–í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–µ —Ä–µ–∫–≤–∏–∑–∏—Ç—ã</div>
                    <div id="userCardDisplay" style="font-family:'JetBrains Mono'; font-size:20px; letter-spacing:3px; color:#fff; margin:20px 0;">0000 0000 0000 0000</div>
                    <div style="font-size:10px; color:var(--accent); font-weight:800; letter-spacing:4px;">PROFIT PLATINUM</div>
                </div>
            </div>
        </div>

        <nav class="dock">
            <button class="dock-item active" onclick="switchTab('pay', this)">–ü–µ—Ä–µ–≤–æ–¥</button>
            <button class="dock-item" onclick="switchTab('chat', this)">–ß–∞—Ç</button>
            <button class="dock-item" onclick="switchTab('hist', this)">–ò—Å—Ç–æ—Ä–∏—è</button>
            <button class="dock-item" onclick="switchTab('prof', this)">–ü—Ä–æ—Ñ–∏–ª—å</button>
        </nav>

        <div id="tab-pay" class="content-section tab-pane">
            <h2>üí∏ –ü–µ—Ä–µ–≤–µ—Å—Ç–∏ –¥–µ–Ω—å–≥–∏</h2>
            <div class="input-group">
                <label>–ü–æ–ª—É—á–∞—Ç–µ–ª—å –∏–∑ –±–∞–∑—ã</label>
                <select id="payTarget"></select>
            </div>
            <div class="input-group">
                <label>–°—É–º–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∏—è</label>
                <input type="number" id="payAmount" placeholder="0.00 ‚ÇΩ">
            </div>
            <div class="input-group">
                <label>–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–µ–æ–±—è–∑–∞—Ç–µ–ª—å–Ω–æ)</label>
                <input type="text" id="payNote" placeholder="–ù–∞–ø—Ä: –ó–∞ –∫–æ—Ñ–µ">
            </div>
            <button class="btn-action" onclick="executePayment()">–ü–û–î–ü–ò–°–ê–¢–¨ –¢–†–ê–ù–ó–ê–ö–¶–ò–Æ</button>
        </div>

        <div id="tab-chat" class="content-section tab-pane hidden">
            <h2>üí¨ –ß–∞—Ç</h2>
            <div id="chatView"></div>
            <div style="display:flex; gap:12px; margin-top:20px;">
                <input type="text" id="chatInput" placeholder="–í–∞—à–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="margin-bottom:0;">
                <button class="btn-action" style="width:70px; padding:0;" onclick="sendChatMessage()">></button>
            </div>
        </div>

        <div id="tab-hist" class="content-section tab-pane hidden">
            <h2>üìú –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h2>
            <div id="histContainer"></div>
        </div>

        <div id="tab-prof" class="content-section tab-pane hidden">
            <h2>üë§ –ü—Ä–æ—Ñ–∏–ª—å</h2>
            
            <button class="btn-action" style="background:var(--panel); color:var(--accent); border:1px solid var(--accent); margin-bottom:25px;" onclick="updatePhoto()">–û–ë–ù–û–í–ò–¢–¨ –ë–ò–û–ú–ï–¢–†–ò–Æ (–§–û–¢–û)</button>

            <div class="progress-container">
                <div style="display:flex; justify-content:space-between; font-size:11px;">
                    <span style="color:var(--muted)">–î–Ω–µ–≤–Ω–æ–π –ª–∏–º–∏—Ç</span>
                    <span style="color:var(--accent)">75% –∏–∑—Ä–∞—Å—Ö–æ–¥–æ–≤–∞–Ω–æ</span>
                </div>
                <div class="progress-bar"><div class="progress-fill"></div></div>
            </div>

            <div class="stats-grid">
                <div class="stat-item">
                    <span class="stat-val">VIP</span>
                    <span class="stat-label">–°—Ç–∞—Ç—É—Å</span>
                </div>
                <div class="stat-item">
                    <span class="stat-val" id="totalTrans">0</span>
                    <span class="stat-label">–û–ø–µ—Ä–∞—Ü–∏–π</span>
                </div>
            </div>

            <div style="margin-top:30px;">
                <div class="input-group">
                    <label>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</label>
                    <input type="password" id="newPassKey" placeholder="–°–º–µ–Ω–∏—Ç—å –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á">
                </div>
                <button class="btn-action" style="background:var(--panel); font-size:12px; height:50px; padding:0;" onclick="changeKey()">–°–û–•–†–ê–ù–ò–¢–¨ –ö–õ–Æ–ß</button>
            </div>

            <button onclick="location.reload()" style="width:100%; margin-top:40px; background:none; border:none; color:var(--error); font-weight:900; cursor:pointer; font-size:12px; letter-spacing:2px;">–í–´–ô–¢–ò –ò–ó –°–ò–°–¢–ï–ú–´</button>
        </div>

    </div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbzsLK9FxBEOFl4XDliOBm-qdmCRJL_Du4uOUjQrGqIdghrvqdt2_4YSbeNeSON2hDxrqg/exec';
        
        let userData = { email: '', name: '', balance: 0, isPrivate: false };
        const userDb = {
            'ilyasvaliev@mail.ru': '–ò–ª—å—è—Å –í–∞–ª–∏–µ–≤',
            'prokhormart@mail.ru': '–ü—Ä–æ—Ö–æ—Ä –ú–∞—Ä—Ç',
            'romankisel@mail.ru': '–†–æ–º–∞–Ω –ö–∏—Å–µ–ª—å',
            'artemant@mail.ru': '–ê—Ä—Ç–µ–º –ê–Ω—Ç'
        };

        // --- –õ–û–ì–ò–ö–ê –ü–ï–†–ï–ö–õ–Æ–ß–ï–ù–ò–Ø ---
        function switchTab(id, btn) {
            document.querySelectorAll('.tab-pane').forEach(p => p.classList.add('hidden'));
            document.getElementById('tab-' + id).classList.remove('hidden');
            document.querySelectorAll('.dock-item').forEach(d => d.classList.remove('active'));
            btn.classList.add('active');
        }

        function toggleBalance(e) {
            e.stopPropagation();
            userData.isPrivate = !userData.isPrivate;
            updateBalanceDisplay();
        }

        function updateBalanceDisplay() {
            const el = document.getElementById('userBalDisplay');
            el.innerText = userData.isPrivate ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚ÇΩ' : (userData.balance).toLocaleString() + ' ‚ÇΩ';
        }

        // --- –°–ò–°–¢–ï–ú–ê –í–•–û–î–ê ---
        async function handleLogin() {
            const email = document.getElementById('logEmail').value.trim().toLowerCase();
            const pass = document.getElementById('logPass').value.trim();
            if(!email || !pass) return;

            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'login', email, password: pass }) });
                const d = await res.json();

                if(d.success) {
                    userData = { email, name: userDb[email] || email, balance: d.balance };
                    
                    document.getElementById('userBalDisplay').innerText = d.balance.toLocaleString() + ' ‚ÇΩ';
                    document.getElementById('userCardDisplay').innerText = d.card;
                    document.getElementById('userNameDisplay').innerText = userData.name;
                    document.getElementById('userAva').src = d.avatar || 'https://via.placeholder.com/150/111/ffd600?text=USER';
                    
                    document.getElementById('loginScreen').classList.add('hidden');
                    document.getElementById('mainApp').classList.remove('hidden');

                    setupReceivers();
                    syncData();
                    setInterval(syncData, 5000);
                } else {
                    document.getElementById('loginError').style.display = 'block';
                }
            } catch(e) { alert("–û–®–ò–ë–ö–ê –ü–û–î–ö–õ–Æ–ß–ï–ù–ò–Ø –ö –°–ï–†–í–ï–†–£"); }
        }

        function setupReceivers() {
            const sel = document.getElementById('payTarget');
            sel.innerHTML = '<option value="">–í–´–ë–ï–†–ò–¢–ï –ü–û–õ–£–ß–ê–¢–ï–õ–Ø</option>';
            for(let key in userDb) {
                if(key !== userData.email) sel.innerHTML += `<option value="${key}">${userDb[key]}</option>`;
            }
        }

        // --- –ü–ï–†–ï–í–û–î ---
        // --- –ü–ï–†–ï–í–û–î ---
        async function executePayment() {
            const to = document.getElementById('payTarget').value;
            const amt = document.getElementById('payAmount').value;
            const note = document.getElementById('payNote').value;
            if(!to || amt <= 0) return alert("–û–®–ò–ë–ö–ê: –ó–ê–ü–û–õ–ù–ò–¢–ï –í–°–ï –ü–û–õ–Ø");

            const ov = document.getElementById('procOverlay');
            ov.classList.add('active');
            document.getElementById('procTitle').innerText = "–ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø...";

            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'transfer', from: userData.email, to, amount: amt, comment: note }) });
                const d = await res.json();

                if(d.success) {
                    document.getElementById('procTitle').innerText = "–£–°–ü–ï–®–ù–û";
                    document.getElementById('procTitle').style.color = "var(--success)";
                    setTimeout(() => {
                        ov.classList.remove('active');
                        document.getElementById('payAmount').value = '';
                        document.getElementById('payNote').value = '';
                        syncData();
                    }, 1500);
                } else {
                    document.getElementById('procTitle').innerText = "–û–¢–ö–õ–û–ù–ï–ù–û";
                    document.getElementById('procTitle').style.color = "var(--error)";
                    setTimeout(() => ov.classList.remove('active'), 1500);
                }
            } catch(e) { ov.classList.remove('active'); }
        }

        // --- –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ---
        async function syncData() {
            if(!userData.email) return;
            try {
                // –ë–∞–ª–∞–Ω—Å
                const bRes = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'balance', email: userData.email }) });
                const bD = await bRes.json();
                userData.balance = bD.balance;
                if(!userData.isPrivate) updateBalanceDisplay();

                // –ò—Å—Ç–æ—Ä–∏—è
                const hRes = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'history', email: userData.email }) });
                const hD = await hRes.json();
                document.getElementById('totalTrans').innerText = hD.history.length;
                
                document.getElementById('histContainer').innerHTML = hD.history.map(h => {
                    const isDebit = h[1].toLowerCase() === userData.email;
                    const partner = isDebit ? h[2] : h[1];
                    return `
                        <div class="hist-card" style="border-left-color: ${isDebit ? 'var(--error)' : 'var(--success)'}">
                            <div class="icon-box" style="background:${isDebit?'#2a151b':'#152a1e'}; color:${isDebit?'var(--error)':'var(--success)'}">
                                ${isDebit ? '‚Üó' : '‚Üô'}
                            </div>
                            <div style="flex:1">
                                <span style="display:block; font-weight:800; font-size:14px;">${userDb[partner] || partner}</span>
                                <span style="font-size:10px; color:var(--muted);">${h[4] || '–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è Profit'}</span>
                            </div>
                            <div style="font-weight:900; color:${isDebit?'var(--error)':'var(--success)'}">
                                ${isDebit ? '-' : '+'}${h[3]} ‚ÇΩ
                            </div>
                        </div>
                    `;
                }).join('');

                // –ß–∞—Ç
                const cRes = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'chat', sub: 'get' }) });
                const cD = await cRes.json();
                document.getElementById('chatView').innerHTML = cD.messages.map(m => `
                    <div class="bubble ${m[1] === userData.name ? 'me' : ''}">
                        <img src="${m[3] || 'https://via.placeholder.com/40'}" style="width:35px; height:35px; border-radius:50%; border:1px solid var(--accent)">
                        <div class="bubble-msg">
                            <span class="bubble-info">${m[1]}</span>
                            <div style="font-size:14px;">${m[2]}</div>
                        </div>
                    </div>
                `).join('');

            } catch(e) { console.warn("Sync error"); }
        }

        // --- –î–û–ü –§–£–ù–ö–¶–ò–ò ---
        async function sendChatMessage() {
            const inp = document.getElementById('chatInput');
            if(!inp.value.trim()) return;
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'chat', sub: 'send', email: userData.email, name: userData.name, text: inp.value }) });
            inp.value = '';
            syncData();
        }

        async function updatePhoto() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: true });
                const v = document.createElement('video'); v.srcObject = s; await v.play();
                setTimeout(async () => {
                    const c = document.createElement('canvas'); c.width = 300; c.height = 300;
                    c.getContext('2d').drawImage(v, 0, 0, 300, 300);
                    const img = c.toDataURL('image/jpeg', 0.6);
                    document.getElementById('userAva').src = img;
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateAvatar', email: userData.email, image: img }) });
                    s.getTracks().forEach(t => t.stop());
                }, 1500);
            } catch(e) { alert("–ö–ê–ú–ï–†–ê –ù–ï–î–û–°–¢–£–ü–ù–ê"); }
        }

        async function changeKey() {
            const p = document.getElementById('newPassKey').value;
            if(p.length < 4) return alert("–ú–ò–ù–ò–ú–£–ú 4 –°–ò–ú–í–û–õ–ê");
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'changePassword', email: userData.email, newPassword: p }) });
            document.getElementById('newPassKey').value = '';
            alert("–ö–õ–Æ–ß –ò–ó–ú–ï–ù–ï–ù");
        }

    </script>
</body>
</html>
