<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>PayBank</title>

<style>
body{
  margin:0;
  background:#0b0b10;
  font-family:-apple-system,BlinkMacSystemFont;
  color:white;
}
.center{
  display:flex;
  justify-content:center;
  align-items:center;
  height:100vh;
}
.panel{
  width:380px;
  background:#14151c;
  border-radius:28px;
  padding:24px;
  box-shadow:0 40px 120px #000;
}
input,select,button{
  width:100%;
  padding:14px;
  margin-top:14px;
  background:#1e1f28;
  border:none;
  border-radius:14px;
  color:white;
  font-size:15px;
}
button{
  background:#ffd600;
  color:black;
  font-weight:600;
}
.exit{
  background:#2a2b35;
  color:white;
}
.card{
  height:160px;
  border-radius:22px;
  background:linear-gradient(135deg,#1e2030,#0f1018);
  padding:20px;
  perspective:900px;
  cursor:pointer;
}
.card-inner{
  position:relative;
  width:100%;
  height:100%;
  transform-style:preserve-3d;
  transition:0.8s;
}
.card.flip .card-inner{
  transform:rotateY(180deg);
}
.card-side{
  position:absolute;
  width:100%;
  height:100%;
  backface-visibility:hidden;
}
.card-back{
  transform:rotateY(180deg);
}
.history{
  margin-top:14px;
  font-size:14px;
  opacity:.85;
}
.history div{
  margin-top:6px;
}
</style>
</head>

<body>

<div class="center" id="login">
  <div class="panel">
    <h2>PayBank</h2>
    <input id="email" placeholder="Email">
    <input id="password" placeholder="Пароль" type="password">
    <button onclick="loginUser()">Войти</button>
  </div>
</div>

<div class="center" id="app" style="display:none">
  <div class="panel">

    <div class="card" onclick="flipCard()">
      <div class="card-inner">
        <div class="card-side">
          <div>Баланс</div>
          <h1 id="balance"></h1>
        </div>
        <div class="card-side card-back">
          <div>Номер карты</div>
          <h2 id="cardNumber"></h2>
        </div>
      </div>
    </div>

    <select id="users"></select>
    <input id="amount" placeholder="Сумма">
    <input id="comment" placeholder="Комментарий">
    <button onclick="send()">Перевести</button>

    <div class="history" id="history"></div>

    <button class="exit" onclick="logout()">Выйти</button>

  </div>
</div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbxTgtfPJfP56bxuC98OnUE47EFEScgZrlASyFSe3Hcr9A0PMU8PRBr9QUal4Gta8LKzBw/exec';
let me = null;

function api(data){
  return fetch(API,{
    method:'POST',
    headers:{
      'Content-Type':'application/json'
    },
    body: JSON.stringify(data)
  }).then(r=>r.json());
}

function loginUser(){
  api({
    action:'login',
    email: email.value,
    password: password.value
  }).then(d=>{
    if(!d.ok){
      alert('Неверные данные');
      return;
    }

    me = d;
    document.getElementById('login').style.display='none';
    document.getElementById('app').style.display='flex';

    balance.innerText = d.balance + ' ₽';
    cardNumber.innerText = d.card;

    loadUsers();
    loadHistory();
  });
}

function loadUsers(){
  api({
    action:'getUsers',
    email: me.email
  }).then(d=>{
    users.innerHTML = d.map(u=>`<option>${u}</option>`).join('');
  });
}

function send(){
  api({
    action:'transfer',
    from: me.email,
    to: users.value,
    amount: Number(amount.value),
    comment: comment.value
  }).then(d=>{
    if(d.error){
      alert(d.error);
      return;
    }
    balance.innerText = d.balance + ' ₽';
    amount.value = '';
    comment.value = '';
    loadHistory();
  });
}

function loadHistory(){
  api({
    action:'history',
    email: me.email
  }).then(d=>{
    history.innerHTML = d.map(r=>{
      const sign = r[1] === me.email ? '−' : '+';
      return `<div>${sign}${r[3]} ₽ · ${r[4]}</div>`;
    }).join('');
  });
}

function flipCard(){
  document.querySelector('.card').classList.toggle('flip');
}

function logout(){
  location.reload();
}
</script>

</body>
</html>
