<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <title>PROFIT NFC PLATINUM</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;900&family=Inter:wght@300;600;800&display=swap" rel="stylesheet">
    <style>
        :root { --accent: #ffd600; --bg: #050507; --panel: #111116; --glass: rgba(255,255,255,0.03); }
        body { margin:0; background:var(--bg); color:#fff; font-family:'Inter'; overflow:hidden; }
        
        /* АНИМАЦИЯ АВТОРИЗАЦИИ */
        .auth-screen { height:100vh; display:flex; flex-direction:column; justify-content:center; align-items:center; padding:30px; transition: 0.5s; }
        .auth-card { background:var(--panel); padding:40px; border-radius:35px; border:1px solid rgba(255,214,0,0.1); width:100%; max-width:350px; text-align:center; box-shadow: 0 20px 50px rgba(0,0,0,0.5); }
        
        input { width:100%; padding:18px; background:#000; border:1px solid #222; border-radius:15px; color:#fff; margin-bottom:15px; font-size:16px; transition:0.3s; box-sizing:border-box; }
        input:focus { border-color:var(--accent); box-shadow: 0 0 15px rgba(255,214,0,0.1); }
        
        .btn { width:100%; padding:20px; background:var(--accent); border:none; border-radius:15px; font-weight:900; font-family:'Orbitron'; cursor:pointer; text-transform:uppercase; transition:0.3s; }
        .btn:active { transform: scale(0.95); }

        /* ОСНОВНОЙ ИНТЕРФЕЙС */
        .app-shell { height:100vh; display:flex; flex-direction:column; transition: 0.5s; }
        .header { padding:25px; text-align:center; }
        .balance-label { font-size:12px; color:#666; letter-spacing:2px; margin-bottom:5px; }
        .balance-main { font-family:'Orbitron'; font-size:42px; font-weight:900; transition: 0.5s; }
        
        /* NFC ВКЛАДКА */
        .nfc-area { flex:1; display:flex; flex-direction:column; align-items:center; justify-content:center; padding:20px; }
        .nfc-ring { width:200px; height:200px; border-radius:50%; border:2px dashed var(--accent); display:flex; align-items:center; justify-content:center; animation: rotate 10s linear infinite; }
        @keyframes rotate { from { transform:rotate(0deg); } to { transform:rotate(360deg); } }
        
        /* ИСТОРИЯ */
        .hist-list { flex:1; overflow-y:auto; padding:0 20px; }
        .hist-item { background:var(--glass); padding:15px; border-radius:20px; margin-bottom:10px; border-left:4px solid var(--accent); animation: slideIn 0.4s ease-out; }
        @keyframes slideIn { from { opacity:0; transform:translateX(-20px); } to { opacity:1; transform:translateX(0); } }

        .nav { display:flex; background:var(--panel); padding:10px; border-radius:25px 25px 0 0; gap:10px; }
        .nav-item { flex:1; padding:15px; text-align:center; font-size:10px; font-weight:800; color:#555; text-transform:uppercase; cursor:pointer; }
        .nav-item.active { color:var(--accent); }

        .hidden { display:none; opacity:0; }
        .amount-up { color: #00ff88; animation: pulseGlow 1s; }
        .amount-down { color: #ff3366; }
    </style>
</head>
<body>

<div id="auth" class="auth-screen">
    <div class="auth-card">
        <h2 style="font-family:'Orbitron'; color:var(--accent);">PROFIT LOGIN</h2>
        <input type="email" id="email" placeholder="EMAIL">
        <input type="password" id="pass" placeholder="PASSWORD">
        <button class="btn" onclick="login()">ENTER SYSTEM</button>
    </div>
</div>

<div id="main" class="app-shell hidden">
    <div class="header">
        <div class="balance-label">CURRENT ASSETS</div>
        <div id="bal" class="balance-main">0 ₽</div>
    </div>

    <div id="view-nfc" class="tab-content nfc-area">
        <div class="nfc-ring">
            <div style="font-family:'Orbitron'; font-size:12px; color:var(--accent); animation: none !important;">NFC ACTIVE</div>
        </div>
        <p id="nfc-status" style="margin-top:20px; color:#666;">Положите телефон на метку</p>
        <button class="btn" style="width:200px; margin-top:20px;" onclick="bindNFC()">ПРИВЯЗАТЬ NFC</button>
    </div>

    <div id="view-hist" class="tab-content hist-list hidden">
        <h3 style="font-family:'Orbitron'; color:var(--accent);">HISTORY</h3>
        <div id="hist-items"></div>
    </div>

    <nav class="nav">
        <div class="nav-item active" onclick="showTab('nfc', this)">NFC PAY</div>
        <div class="nav-item" onclick="showTab('hist', this)">HISTORY</div>
    </nav>
</div>

<script>
const API = 'https://script.google.com/macros/s/AKfycbzyUa_zQ842I8tP0J4pJwyO5F7UTRx8fRW7XseL6G_gdQcbnClHOvOcvYTZiAg6XWzaCA/exec';
let user = null;
let currentBal = 0;

async function login() {
    const res = await fetch(API, {method:'POST', body:JSON.stringify({
        action:'login', email:document.getElementById('email').value, pass:document.getElementById('pass').value
    })});
    const d = await res.json();
    if(d.success) {
        user = { email:document.getElementById('email').value, ...d };
        document.getElementById('auth').classList.add('hidden');
        setTimeout(() => {
            document.getElementById('auth').style.display = 'none';
            document.getElementById('main').classList.remove('hidden');
            sync();
            startNFC();
        }, 500);
    } else alert("Ошибка входа");
}

function animateBalance(newVal) {
    const el = document.getElementById('bal');
    const start = currentBal;
    const diff = newVal - start;
    if(diff === 0) return;
    
    el.classList.remove('amount-up', 'amount-down');
    el.classList.add(diff > 0 ? 'amount-up' : 'amount-down');
    
    let startTime = null;
    function step(timestamp) {
        if (!startTime) startTime = timestamp;
        const progress = Math.min((timestamp - startTime) / 800, 1);
        const val = Math.floor(progress * (newVal - start) + start);
        el.innerText = val.toLocaleString() + ' ₽';
        if (progress < 1) window.requestAnimationFrame(step);
    }
    window.requestAnimationFrame(step);
    currentBal = newVal;
}

async function sync() {
    const res = await fetch(API, {method:'POST', body:JSON.stringify({action:'sync', email:user.email})});
    const d = await res.json();
    animateBalance(d.bal);
    
    document.getElementById('hist-items').innerHTML = d.history.map(h => `
        <div class="hist-item">
            <div style="font-size:10px; color:#555;">${new Date(h[0]).toLocaleString()}</div>
            <div style="font-weight:800; margin:5px 0;">
                ${h[1] === user.email ? 'ВЫ ОТПРАВИЛИ' : 'ВАМ ПЕРЕВЕЛИ'} ${h[3]} ₽
            </div>
            <div style="font-size:12px; color:var(--accent);">${h[4]}</div>
        </div>
    `).join('');
}

// РАБОТА С NFC
async function startNFC() {
    if ('NDEFReader' in window) {
        try {
            const ndef = new NDEFReader();
            await ndef.scan();
            ndef.onreading = async ({ serialNumber }) => {
                const amount = prompt("Сумма к списанию с этой метки:", "100");
                if(!amount) return;

                document.getElementById('nfc-status').innerText = "ОБРАБОТКА...";
                const res = await fetch(API, {method:'POST', body:JSON.stringify({
                    action:'nfc_pay', tagId: serialNumber, receiverEmail: user.email, amount: amount
                })});
                const d = await res.json();
                if(d.success) {
                    alert(`Успешно! Списано с ${d.fromName}`);
                    sync();
                } else alert(d.msg || "Ошибка");
                document.getElementById('nfc-status').innerText = "Готово к чтению";
            };
        } catch(e) { console.log(e); }
    } else { document.getElementById('nfc-status').innerText = "NFC не поддерживается браузером"; }
}

async function bindNFC() {
    alert("Подносите метку для привязки к вашему аккаунту...");
    if ('NDEFReader' in window) {
        const ndef = new NDEFReader();
        await ndef.scan();
        ndef.onreading = async ({ serialNumber }) => {
            await fetch(API, {method:'POST', body:JSON.stringify({
                action:'bind_nfc', email: user.email, tagId: serialNumber
            })});
            alert("Метка успешно привязана!");
        };
    }
}

function showTab(id, el) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
    document.getElementById('view-'+id).classList.remove('hidden');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    el.classList.add('active');
}
</script>
</body>
</html>
