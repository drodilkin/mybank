<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>PROFIT BANK | INFINITY NFC TERMINAL</title>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Inter:wght@300;400;600;700;800&family=JetBrains+Mono&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --accent: #ffd600;
            --accent-glow: rgba(255, 214, 0, 0.3);
            --bg: #030305;
            --card-bg: #0d0d12;
            --panel-bg: #15151f;
            --text: #ffffff;
            --muted: #6c6c7a;
            --success: #00ff9d;
            --error: #ff3b6b;
            --border: rgba(255, 255, 255, 0.08);
            --glass: rgba(255, 255, 255, 0.02);
        }

        /* –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò */
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none !important; }
        body { 
            margin: 0; background: var(--bg); color: var(--text); font-family: 'Inter', sans-serif;
            background-image: 
                radial-gradient(circle at 0% 0%, rgba(255,214,0,0.05) 0%, transparent 50%),
                radial-gradient(circle at 100% 100%, rgba(0,255,157,0.05) 0%, transparent 50%);
            min-height: 100vh; overflow-x: hidden;
        }

        .hidden { display: none !important; }

        /* --- –ü—Ä–æ–¥–≤–∏–Ω—É—Ç—ã–µ –ê–Ω–∏–º–∞—Ü–∏–∏ --- */
        @keyframes float { 0%, 100% { transform: translateY(0) rotate(0deg); } 50% { transform: translateY(-12px) rotate(1deg); } }
        @keyframes pulse-ring { 0% { transform: scale(0.3); opacity: 1; } 100% { transform: scale(2.2); opacity: 0; } }
        @keyframes neon-glow { 0%, 100% { filter: drop-shadow(0 0 5px var(--accent)); } 50% { filter: drop-shadow(0 0 15px var(--accent)); } }
        @keyframes slide-up { from { opacity: 0; transform: translateY(30px); } to { opacity: 1; transform: translateY(0); } }
        @keyframes scan-line { 0% { top: 0; } 100% { top: 100%; } }

        .container { width: 100%; max-width: 480px; margin: 0 auto; padding: 25px 15px; animation: slide-up 0.6s cubic-bezier(0.23, 1, 0.32, 1); }

        /* --- –ö–ê–†–¢–ê (VIP –î–ò–ó–ê–ô–ù) --- */
        .card-wrapper { perspective: 1500px; height: 250px; margin-bottom: 40px; }
        .card-inner { 
            position: relative; width: 100%; height: 100%; transition: transform 0.8s cubic-bezier(0.4, 0, 0.2, 1);
            transform-style: preserve-3d; cursor: pointer; animation: float 6s ease-in-out infinite;
        }
        .card-inner.is-flipped { transform: rotateY(180deg); }
        
        .card-front, .card-back {
            position: absolute; inset: 0; border-radius: 35px; padding: 30px;
            backface-visibility: hidden; border: 1px solid var(--border);
            background: linear-gradient(145deg, #1a1a26 0%, #050508 100%);
            box-shadow: 0 25px 50px rgba(0,0,0,0.6);
            display: flex; flex-direction: column; justify-content: space-between;
        }
        
        .card-back { transform: rotateY(180deg); background: #08080c; text-align: center; justify-content: center; }

        .card-chip { width: 50px; height: 40px; background: linear-gradient(135deg, #ffd600 0%, #b88a00 100%); border-radius: 8px; position: relative; overflow: hidden; }
        .card-chip::after { content: ''; position: absolute; inset: 0; background: repeating-linear-gradient(90deg, transparent 0 5px, rgba(0,0,0,0.1) 5px 6px); }

        .balance-display { margin-top: 15px; }
        .balance-display span { font-size: 11px; text-transform: uppercase; letter-spacing: 2px; color: var(--muted); font-weight: 700; }
        .balance-display h1 { font-size: 42px; font-weight: 900; margin: 5px 0; font-family: 'Orbitron'; letter-spacing: -1px; }

        /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø (DOCK) --- */
        .navigation-dock {
            display: flex; background: var(--card-bg); padding: 8px; border-radius: 25px;
            border: 1px solid var(--border); margin-bottom: 30px; position: sticky; top: 15px; z-index: 100;
            backdrop-filter: blur(15px);
        }
        .nav-link {
            flex: 1; padding: 15px 5px; border: none; background: none; color: var(--muted);
            font-size: 10px; font-weight: 800; border-radius: 20px; cursor: pointer;
            transition: 0.3s cubic-bezier(0.4, 0, 0.2, 1); text-transform: uppercase; letter-spacing: 1px;
        }
        .nav-link.active { background: var(--accent); color: #000; box-shadow: 0 10px 20px var(--accent-glow); }

        /* --- –ö–û–ù–¢–ï–ù–¢–ù–´–ï –ë–õ–û–ö–ò --- */
        .glass-card {
            background: var(--card-bg); border-radius: 35px; padding: 30px;
            border: 1px solid var(--border); margin-bottom: 25px;
            position: relative; overflow: hidden;
        }
        h2 { font-size: 22px; font-weight: 900; margin: 0 0 25px 0; color: var(--accent); font-family: 'Orbitron'; display: flex; align-items: center; gap: 12px; }

        .input-box { margin-bottom: 20px; }
        .input-box label { display: block; font-size: 10px; font-weight: 800; color: var(--muted); margin-bottom: 8px; margin-left: 15px; text-transform: uppercase; }
        
        input, select {
            width: 100%; padding: 20px 25px; background: var(--panel-bg); border: 1px solid var(--border);
            border-radius: 20px; color: #fff; font-size: 16px; font-weight: 600; transition: 0.3s;
        }
        input:focus { border-color: var(--accent); box-shadow: 0 0 15px var(--accent-glow); background: #1c1c2b; }

        .action-btn {
            width: 100%; padding: 22px; background: var(--accent); border: none; border-radius: 20px;
            font-weight: 900; font-size: 16px; color: #000; cursor: pointer; transition: 0.3s;
            text-transform: uppercase; letter-spacing: 1px;
        }
        .action-btn:hover { transform: translateY(-3px); box-shadow: 0 15px 30px var(--accent-glow); }
        .action-btn:active { transform: translateY(1px); }

        /* --- –í–ö–õ–ê–î–ö–ê NFC (–†–ê–°–®–ò–†–ï–ù–ù–ê–Ø) --- */
        .nfc-terminal {
            height: 320px; background: #050508; border-radius: 30px; position: relative;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            border: 2px dashed #222; transition: 0.5s;
        }
        .nfc-terminal.active { border-color: var(--accent); }
        .radar-box { position: relative; width: 150px; height: 150px; display: flex; align-items: center; justify-content: center; }
        .ring { position: absolute; border: 2px solid var(--accent); border-radius: 50%; animation: pulse-ring 2.5s infinite; opacity: 0; }
        .nfc-phone-icon { font-size: 60px; z-index: 5; animation: neon-glow 3s infinite; }

        .nfc-status-badge {
            margin-top: 25px; padding: 8px 20px; background: var(--panel-bg);
            border-radius: 50px; border: 1px solid var(--border); font-size: 12px;
            font-weight: 700; color: var(--muted);
        }
        .nfc-status-badge.ready { color: var(--success); border-color: var(--success); }

        /* --- –ß–ê–¢ --- */
        .chat-container { height: 400px; overflow-y: auto; padding-right: 10px; display: flex; flex-direction: column-reverse; gap: 15px; }
        .message { display: flex; gap: 12px; max-width: 85%; animation: slide-up 0.4s ease; }
        .message.own { align-self: flex-end; flex-direction: row-reverse; }
        .msg-bubble { 
            padding: 15px 20px; border-radius: 25px; background: var(--panel-bg); 
            border: 1px solid var(--border); font-size: 14px; line-height: 1.5;
        }
        .message.own .msg-bubble { background: var(--accent); color: #000; border: none; font-weight: 600; }
        .msg-meta { font-size: 9px; font-weight: 800; text-transform: uppercase; color: var(--muted); margin-bottom: 5px; display: block; }

        /* --- –ò–°–¢–û–†–ò–Ø –ò –ì–†–ê–§–ò–ö–ò --- */
        .history-item {
            display: flex; align-items: center; gap: 15px; padding: 18px;
            background: var(--glass); border-radius: 22px; margin-bottom: 12px;
            transition: 0.3s; cursor: pointer; border: 1px solid transparent;
        }
        .history-item:hover { background: rgba(255,255,255,0.05); border-color: var(--border); }
        .item-icon { width: 50px; height: 50px; border-radius: 18px; display: flex; align-items: center; justify-content: center; font-size: 20px; }
        
        .stat-bar-wrap { height: 6px; width: 100%; background: #222; border-radius: 10px; margin: 20px 0; overflow: hidden; }
        .stat-bar-fill { height: 100%; background: var(--accent); width: 0%; transition: 1.5s ease-out; }

        /* --- –≠–ö–†–ê–ù –ó–ê–ì–†–£–ó–ö–ò --- */
        #master-loader {
            position: fixed; inset: 0; background: var(--bg); z-index: 10000;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }
        .loader-orbit {
            width: 100px; height: 100px; border: 3px solid transparent;
            border-top-color: var(--accent); border-radius: 50%;
            animation: rotateLoader 1s linear infinite; position: relative;
        }
        .loader-orbit::before {
            content: ''; position: absolute; inset: 10px; border: 3px solid transparent;
            border-bottom-color: var(--success); border-radius: 50%; animation: rotateLoader 2s linear infinite;
        }

        /* --- –ê–í–¢–û–†–ò–ó–ê–¶–ò–Ø --- */
        #auth-screen { min-height: 100vh; display: flex; align-items: center; justify-content: center; padding: 25px; }
        .auth-card { background: var(--card-bg); padding: 50px 35px; border-radius: 45px; width: 100%; max-width: 420px; text-align: center; border: 1px solid var(--border); }

    </style>
</head>
<body>

    <div id="master-loader">
        <div class="loader-orbit"></div>
        <h2 style="margin-top: 30px; letter-spacing: 5px; font-size: 14px; color: var(--accent);">PROFIT SECURE SYSTEM</h2>
    </div>

    <div id="auth-screen" class="hidden">
        <div class="auth-card">
            <div style="font-family:'Orbitron'; font-size:38px; font-weight:900; color:var(--accent); margin-bottom:5px;">PROFIT</div>
            <div style="font-size:10px; color:var(--muted); letter-spacing:6px; text-transform:uppercase; margin-bottom:45px;">Infinity Banking</div>
            
            <div class="input-box">
                <input type="email" id="auth-email" placeholder="Email (ID –ö–ª–∏–µ–Ω—Ç–∞)">
            </div>
            <div class="input-box">
                <input type="password" id="auth-pass" placeholder="–ú–∞—Å—Ç–µ—Ä-–ø–∞—Ä–æ–ª—å">
            </div>
            <button class="action-btn" onclick="performLogin()">–û—Ç–∫—Ä—ã—Ç—å –¥–æ—Å—Ç—É–ø</button>
            <p id="auth-msg" style="color:var(--error); font-size:12px; margin-top:20px; font-weight:700; display:none;">–û–®–ò–ë–ö–ê: –û–¢–ö–ê–ó–ê–ù–û –í –î–û–°–¢–£–ü–ï</p>
        </div>
    </div>

    <div id="terminal-app" class="container hidden">
        
        <div class="card-wrapper">
            <div class="card-inner" id="main-card" onclick="this.classList.toggle('is-flipped')">
                <div class="card-front">
                    <div style="display:flex; justify-content:space-between; align-items:flex-start;">
                        <div class="card-chip"></div>
                        <img id="user-avatar" src="" style="width:65px; height:65px; border-radius:50%; border:3px solid var(--accent); object-fit:cover; background:#000;">
                    </div>
                    <div class="balance-display" onclick="toggleBalanceSec(event)">
                        <span>–ß–∏—Å—Ç—ã–µ –∞–∫—Ç–∏–≤—ã</span>
                        <h1 id="user-balance">0.00 ‚ÇΩ</h1>
                        <div id="user-name-tag" style="margin-top:10px; font-weight:800; font-size:14px; text-transform:uppercase; color:var(--accent);">–ó–ê–ì–†–£–ó–ö–ê...</div>
                    </div>
                </div>
                <div class="card-back">
                    <span style="font-size:10px; color:var(--muted); letter-spacing:3px;">SECURITY NUMBER</span>
                    <div id="user-card-num" style="font-family:'JetBrains Mono'; font-size:20px; letter-spacing:4px; margin:20px 0; color:#fff;">0000 0000 0000 0000</div>
                    <div style="font-size:11px; font-weight:900; color:var(--accent);">PROFIT INFINITY ‚Ä¢ NO LIMITS</div>
                </div>
            </div>
        </div>

        <nav class="navigation-dock">
            <button class="nav-link active" onclick="route('pay', this)">–ü–ª–∞—Ç–µ–∂</button>
            <button class="nav-link" onclick="route('nfc', this)">NFC Pay</button>
            <button class="nav-link" onclick="route('chat', this)">–ß–∞—Ç</button>
            <button class="nav-link" onclick="route('hist', this)">–ò—Å—Ç–æ—Ä–∏—è</button>
            <button class="nav-link" onclick="route('prof', this)">–ü—Ä–æ—Ñ–∏–ª—å</button>
        </nav>

        <div id="view-pay" class="glass-card view-pane">
            <h2>üí∏ –ü–µ—Ä–µ–≤–æ–¥</h2>
            <div class="input-box">
                <label>–ü–æ–ª—É—á–∞—Ç–µ–ª—å</label>
                <select id="pay-target"></select>
            </div>
            <div class="input-box">
                <label>–°—É–º–º–∞ —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ (‚ÇΩ)</label>
                <input type="number" id="pay-amount" placeholder="0.00">
            </div>
            <div class="input-box">
                <label>–ö–æ–º–º–µ–Ω—Ç–∞—Ä–∏–π</label>
                <input type="text" id="pay-comment" placeholder="–ù–∞–∑–Ω–∞—á–µ–Ω–∏–µ –ø–ª–∞—Ç–µ–∂–∞">
            </div>
            <button class="action-btn" onclick="startPayment()">–ü–æ–¥–ø–∏—Å–∞—Ç—å –∏ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
        </div>

        <div id="view-nfc" class="glass-card view-pane hidden">
            <h2>üì° NFC –ú–æ–¥—É–ª—å</h2>
            <div class="nfc-terminal" id="nfc-zone">
                <div class="ring" style="animation-delay:0s"></div>
                <div class="ring" style="animation-delay:0.8s"></div>
                <div class="ring" style="animation-delay:1.6s"></div>
                <div class="nfc-phone-icon">üì±</div>
                <div class="nfc-status-badge" id="nfc-status">–ì–æ—Ç–æ–≤ –∫ –ø–æ–∏—Å–∫—É –º–µ—Ç–æ–∫</div>
                <div id="nfc-scan-line" style="position:absolute; width:100%; height:2px; background:var(--accent); opacity:0; box-shadow:0 0 10px var(--accent);"></div>
            </div>
            
            <div style="margin-top:25px;">
                <h3 style="font-size:11px; color:var(--muted); text-transform:uppercase; margin-bottom:15px;">–ù–∞—Å—Ç—Ä–æ–π–∫–∞ NFC-—Ç—Ä–∏–≥–≥–µ—Ä–∞:</h3>
                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:12px;">
                    <button class="action-btn" style="background:var(--panel-bg); color:var(--accent); border:1px solid var(--accent); font-size:12px;" onclick="activateNFC()">–°–∫–∞–Ω–∏—Ä–æ–≤–∞—Ç—å</button>
                    <button class="action-btn" style="font-size:12px;" onclick="simulateNFCPay()">–ò–º–∏—Ç–∞—Ü–∏—è</button>
                </div>
                <p id="nfc-result" style="margin-top:20px; font-family:'JetBrains Mono'; font-size:11px; color:var(--success); text-align:center;"></p>
            </div>
        </div>

        <div id="view-chat" class="glass-card view-pane hidden">
            <h2>üí¨ –ì–ª–æ–±–∞–ª—å–Ω—ã–π —á–∞—Ç</h2>
            <div id="chat-wall" class="chat-container"></div>
            <div style="display:flex; gap:10px; margin-top:20px;">
                <input type="text" id="chat-input" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." style="margin:0;">
                <button class="action-btn" style="width:70px; padding:0;" onclick="sendText()">></button>
            </div>
        </div>

        <div id="view-hist" class="glass-card view-pane hidden">
            <h2>üìú –ê–Ω–∞–ª–∏—Ç–∏–∫–∞</h2>
            <div class="stat-bar-wrap"><div class="stat-bar-fill" id="stat-fill"></div></div>
            <div style="display:flex; justify-content:space-between; font-size:11px; color:var(--muted); margin-bottom:25px;">
                <span>–†–∞—Å—Ö–æ–¥—ã: <b id="stat-out" style="color:var(--error)">0 ‚ÇΩ</b></span>
                <span>–î–æ—Ö–æ–¥—ã: <b id="stat-in" style="color:var(--success)">0 ‚ÇΩ</b></span>
            </div>
            <div id="history-list"></div>
        </div>

        <div id="view-prof" class="glass-card view-pane hidden">
            <h2>üë§ –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ</h2>
            <div style="text-align:center; margin-bottom:30px;">
                <button class="action-btn" style="background:var(--panel-bg); color:var(--accent); border:1px dashed var(--accent);" onclick="refreshBio()">üì∏ –û–±–Ω–æ–≤–∏—Ç—å –±–∏–æ–º–µ—Ç—Ä–∏—é</button>
            </div>
            
            <div class="input-box">
                <label>–ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å</label>
                <div style="display:flex; justify-content:space-between; padding:15px; background:var(--panel-bg); border-radius:15px; font-size:13px;">
                    <span style="color:var(--muted)">–°—Ç–∞—Ç—É—Å –ª–∏–º–∏—Ç–æ–≤:</span>
                    <span style="color:var(--success); font-weight:800;">–ë–ï–ó–õ–ò–ú–ò–¢–ù–û</span>
                </div>
            </div>
            
            <div class="input-box">
                <label>–°–º–µ–Ω–∞ –ø–∞—Ä–æ–ª—è</label>
                <input type="password" id="new-key" placeholder="–ù–æ–≤—ã–π –º–∞—Å—Ç–µ—Ä-–∫–ª—é—á">
            </div>
            <button class="action-btn" style="background:var(--panel-bg); font-size:12px; height:50px; padding:0;" onclick="saveKey()">–°–º–µ–Ω–∏—Ç—å –∫–ª—é—á</button>
            
            <button onclick="location.reload()" style="width:100%; margin-top:40px; background:none; border:none; color:var(--error); font-weight:900; font-size:12px; letter-spacing:3px; cursor:pointer;">–í–´–ô–¢–ò –ò–ó –¢–ï–†–ú–ò–ù–ê–õ–ê</button>
        </div>

    </div>

    <script>
        // --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø ---
        const API_URL = 'https://script.google.com/macros/s/AKfycbzsLK9FxBEOFl4XDliOBm-qdmCRJL_Du4uOUjQrGqIdghrvqdt2_4YSbeNeSON2hDxrqg/exec';
        const APP_DB = {
            'ilyasvaliev@mail.ru': '–ò–ª—å—è—Å –í–∞–ª–∏–µ–≤',
            'prokhormart@mail.ru': '–ü—Ä–æ—Ö–æ—Ä –ú–∞—Ä—Ç',
            'romankisel@mail.ru': '–†–æ–º–∞–Ω –ö–∏—Å–µ–ª—å',
            'artemant@mail.ru': '–ê—Ä—Ç–µ–º –ê–Ω—Ç'
        };

        let session = { email: '', name: '', balance: 0, hidden: false };

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        window.onload = () => {
            setTimeout(() => {
                document.getElementById('master-loader').style.display = 'none';
                document.getElementById('auth-screen').classList.remove('hidden');
            }, 2000);
        };

        // --- –ù–ê–í–ò–ì–ê–¶–ò–Ø ---
        function route(tabId, btn) {
            document.querySelectorAll('.view-pane').forEach(p => p.classList.add('hidden'));
            document.getElementById('view-' + tabId).classList.remove('hidden');
            document.querySelectorAll('.nav-link').forEach(l => l.classList.remove('active'));
            btn.classList.add('active');
            
            if(tabId === 'hist') animateStats();
        }

        function toggleBalanceSec(e) {
            e.stopPropagation();
            session.hidden = !session.hidden;
            renderBalance();
        }

        function renderBalance() {
            const el = document.getElementById('user-balance');
            el.innerText = session.hidden ? '‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢ ‚ÇΩ' : session.balance.toLocaleString() + ' ‚ÇΩ';
        }

       // --- –õ–û–ì–ò–ö–ê –ê–í–¢–û–†–ò–ó–ê–¶–ò–ò ---
        async function performLogin() {
            const email = document.getElementById('auth-email').value.trim().toLowerCase();
            const pass = document.getElementById('auth-pass').value.trim();
            if(!email || !pass) return;

            setLoader(true, "–ü–†–û–í–ï–†–ö–ê –í –ë–ê–ó–ï...");
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'login', email, password: pass }) });
                const d = await res.json();

                if(d.success) {
                    session.email = email;
                    session.name = APP_DB[email] || email;
                    session.balance = d.balance;

                    document.getElementById('user-name-tag').innerText = session.name;
                    document.getElementById('user-card-num').innerText = d.card;
                    document.getElementById('user-avatar').src = d.avatar || 'https://via.placeholder.com/150/000/ffd600?text=USER';
                    renderBalance();

                    document.getElementById('auth-screen').classList.add('hidden');
                    document.getElementById('terminal-app').classList.remove('hidden');

                    initPayList();
                    refreshData();
                    setInterval(refreshData, 5000);
                } else {
                    document.getElementById('auth-msg').style.display = 'block';
                }
            } catch(e) { alert("–û–®–ò–ë–ö–ê –°–ï–¢–ò"); }
            setLoader(false);
        }

        function initPayList() {
            const sel = document.getElementById('pay-target');
            sel.innerHTML = '<option value="">–í–´–ë–ï–†–ò–¢–ï –ü–û–õ–£–ß–ê–¢–ï–õ–Ø</option>';
            for(let key in APP_DB) {
                if(key !== session.email) sel.innerHTML += `<option value="${key}">${APP_DB[key]}</option>`;
            }
        }

        // --- NFC –§–£–ù–ö–¶–ò–û–ù–ê–õ ---
        async function activateNFC() {
            const status = document.getElementById('nfc-status');
            const zone = document.getElementById('nfc-zone');
            
            if (!('NDEFReader' in window)) {
                status.innerText = "NFC –ù–ï –ü–û–î–î–ï–†–ñ–ò–í–ê–ï–¢–°–Ø";
                status.style.color = "var(--error)";
                return;
            }

            try {
                const ndef = new NDEFReader();
                await ndef.scan();
                zone.classList.add('active');
                status.innerText = "–ü–û–ò–°–ö –ú–ï–¢–ö–ò...";
                status.classList.add('ready');

                ndef.onreading = event => {
                    const id = event.serialNumber;
                    document.getElementById('nfc-result').innerText = "ID –ú–ï–¢–ö–ò: " + id + " | –ü–†–ò–í–Ø–ó–ê–ù–û";
                    status.innerText = "–ú–ï–¢–ö–ê –û–ë–ù–ê–†–£–ñ–ï–ù–ê";
                    // –ó–¥–µ—Å—å –º–æ–∂–Ω–æ –≤—ã–∑–≤–∞—Ç—å —Ñ—É–Ω–∫—Ü–∏—é –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ –ø–ª–∞—Ç–µ–∂–∞
                };
            } catch(e) { status.innerText = "–û–®–ò–ë–ö–ê –î–ê–¢–ß–ò–ö–ê"; }
        }

        function simulateNFCPay() {
            const status = document.getElementById('nfc-status');
            const line = document.getElementById('nfc-scan-line');
            
            status.innerText = "–°–ò–ú–£–õ–Ø–¶–ò–Ø NFC...";
            line.style.opacity = '1';
            line.animate([{ top: '0%' }, { top: '100%' }], { duration: 1000, iterations: 2 });

            setTimeout(() => {
                const fakeId = "INF-" + Math.floor(Math.random()*99999);
                document.getElementById('nfc-result').innerText = "–°–ß–ò–¢–ê–ù–ê –ú–ï–¢–ö–ê: " + fakeId;
                status.innerText = "–û–ü–õ–ê–¢–ê –ü–û NFC –î–û–°–¢–£–ü–ù–ê";
                line.style.opacity = '0';
            }, 2000);
        }

        // --- –ü–õ–ê–¢–ï–ñ–ò ---
        async function startPayment() {
            const to = document.getElementById('pay-target').value;
            const amt = document.getElementById('pay-amount').value;
            if(!to || amt <= 0) return alert("–ü–†–û–í–ï–†–¨–¢–ï –î–ê–ù–ù–´–ï");

            setLoader(true, "–®–ò–§–†–û–í–ê–ù–ò–ï...");
            try {
                const res = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ 
                    action: 'transfer', from: session.email, to, amount: amt, comment: document.getElementById('pay-comment').value 
                }) });
                const d = await res.json();

                if(d.success) {
                    setLoader(true, "–í–´–ü–û–õ–ù–ï–ù–û");
                    setTimeout(() => {
                        setLoader(false);
                        document.getElementById('pay-amount').value = '';
                        refreshData();
                    }, 1200);
                }
            } catch(e) { setLoader(false); }
        }

        // --- –°–ò–ù–•–†–û–ù–ò–ó–ê–¶–ò–Ø ---
        async function refreshData() {
            if(!session.email) return;
            try {
                const bRes = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'balance', email: session.email }) });
                const bD = await bRes.json();
                session.balance = bD.balance;
                renderBalance();

                const hRes = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'history', email: session.email }) });
                const hD = await hRes.json();
                
                let outSum = 0, inSum = 0;
                document.getElementById('history-list').innerHTML = hD.history.map(h => {
                    const isOut = h[1].toLowerCase() === session.email;
                    const val = parseFloat(h[3]);
                    isOut ? outSum += val : inSum += val;

                    return `
                        <div class="history-item">
                            <div class="item-icon" style="background:${isOut?'#25151b':'#15251e'}; color:${isOut?'var(--error)':'var(--success)'}">
                                ${isOut ? '‚Üó' : '‚Üô'}
                            </div>
                            <div style="flex:1">
                                <span style="display:block; font-weight:700; font-size:14px;">${APP_DB[isOut?h[2]:h[1]] || '–í–Ω–µ—à–Ω–∏–π —Å—á–µ—Ç'}</span>
                                <span style="font-size:10px; color:var(--muted);">${h[4] || 'Profit Transaction'}</span>
                            </div>
                            <div style="font-weight:900; color:${isOut?'var(--error)':'var(--success)'}">
                                ${isOut?'-':'+'}${val} ‚ÇΩ
                            </div>
                        </div>
                    `;
                }).join('');

                document.getElementById('stat-out').innerText = outSum + " ‚ÇΩ";
                document.getElementById('stat-in').innerText = inSum + " ‚ÇΩ";
                session.stats = { out: outSum, in: inSum };

                const cRes = await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'chat', sub: 'get' }) });
                const cD = await cRes.json();
                document.getElementById('chat-wall').innerHTML = cD.messages.map(m => `
                    <div class="message ${m[1] === session.name ? 'own' : ''}">
                        <div class="msg-bubble">
                            <span class="msg-meta">${m[1]}</span>
                            ${m[2]}
                        </div>
                    </div>
                `).join('');
            } catch(e) {}
        }

        function animateStats() {
            const fill = document.getElementById('stat-fill');
            const total = session.stats.in + session.stats.out;
            const percent = total > 0 ? (session.stats.out / total) * 100 : 0;
            setTimeout(() => { fill.style.width = percent + '%'; }, 100);
        }

        async function sendText() {
            const inp = document.getElementById('chat-input');
            if(!inp.value.trim()) return;
            await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'chat', sub: 'send', email: session.email, name: session.name, text: inp.value }) });
            inp.value = '';
            refreshData();
        }

        async function refreshBio() {
            try {
                const s = await navigator.mediaDevices.getUserMedia({ video: true });
                const v = document.createElement('video'); v.srcObject = s; await v.play();
                setTimeout(async () => {
                    const c = document.createElement('canvas'); c.width = 300; c.height = 300;
                    c.getContext('2d').drawImage(v, 0, 0, 300, 300);
                    const img = c.toDataURL('image/jpeg', 0.6);
                    document.getElementById('user-avatar').src = img;
                    await fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'updateAvatar', email: session.email, image: img }) });
                    s.getTracks().forEach(t => t.stop());
                }, 1500);
            } catch(e) { alert("–î–û–°–¢–£–ü –ö –ö–ê–ú–ï–†–ï –ó–ê–ë–õ–û–ö–ò–†–û–í–ê–ù"); }
        }

        function saveKey() {
            const k = document.getElementById('new-key').value;
            if(k) {
                fetch(API_URL, { method: 'POST', body: JSON.stringify({ action: 'changePassword', email: session.email, newPassword: k }) });
                alert("–ö–õ–Æ–ß –û–ë–ù–û–í–õ–ï–ù");
                document.getElementById('new-key').value = '';
            }
        }

        function setLoader(show, msg = "") {
            const l = document.getElementById('master-loader');
            l.querySelector('h2').innerText = msg;
            l.style.display = show ? 'flex' : 'none';
        }

    </script>
    <style> @keyframes rotateLoader { to { transform: rotate(360deg); } } </style>
</body>
</html>
