<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>üè¶ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫ - –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        .container { 
            max-width: 500px; 
            margin: 0 auto; 
            background: white; 
            padding: 30px; 
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        h1 { color: #333; margin-bottom: 30px; text-align: center; }
        input { 
            width: 100%; 
            padding: 12px; 
            margin: 10px 0; 
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
        }
        button { 
            width: 100%; 
            padding: 14px; 
            background: linear-gradient(to right, #667eea, #764ba2);
            color: white; 
            border: none; 
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            margin: 10px 0;
        }
        .balance { 
            font-size: 32px; 
            text-align: center; 
            margin: 20px 0;
            color: #28a745;
            font-weight: bold;
        }
        .message { 
            padding: 10px; 
            margin: 10px 0; 
            border-radius: 5px; 
            text-align: center;
        }
        .success { background: #d4edda; color: #155724; }
        .error { background: #f8d7da; color: #721c24; }
        .info { background: #d1ecf1; color: #0c5460; }
        .user-card {
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 8px;
            margin: 5px 0;
            background: #f8f9fa;
        }
        .logout-btn { background: #dc3545; }
    </style>
</head>
<body>
    <div class="container">
        <h1>üè¶ –í–∏—Ä—Ç—É–∞–ª—å–Ω—ã–π –ë–∞–Ω–∫</h1>
        
        <!-- –≠–∫—Ä–∞–Ω –≤—Ö–æ–¥–∞ -->
        <div id="loginScreen">
            <h3>–í—Ö–æ–¥ –≤ —Å–∏—Å—Ç–µ–º—É</h3>
            <input type="text" id="loginEmail" placeholder="Email" value="tilyas@mail.ru">
            <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª—å" value="80223">
            <button onclick="login()">–í–æ–π—Ç–∏ –≤ –±–∞–Ω–∫</button>
            
            <div class="message info">
                <strong>–í—Å–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:</strong><br>
                ‚Ä¢ tilyas@mail.ru / 80223<br>
                ‚Ä¢ Prokhor@mail.ru / 71601<br>
                ‚Ä¢ Roma@mail.ru / 23312<br>
                ‚Ä¢ Artem@mail.ru / 94331
            </div>
            
            <div id="loginMessage" class="message"></div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω –±–∞–Ω–∫–∞ -->
        <div id="bankScreen" style="display:none">
            <h3>üëã –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, <span id="userName"></span>!</h3>
            <div class="balance" id="balance">50000 ‚Çø</div>
            
            <h4>üí∏ –ü–µ—Ä–µ–≤–æ–¥ —Å—Ä–µ–¥—Å—Ç–≤</h4>
            <select id="toEmail" style="width:100%; padding:12px; margin:10px 0; border-radius:8px;">
                <option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</option>
            </select>
            <input type="number" id="amount" placeholder="–°—É–º–º–∞ –ø–µ—Ä–µ–≤–æ–¥–∞" min="1" max="50000">
            
            <button onclick="makeTransfer()">‚úÖ –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥</button>
            <button onclick="logout()" class="logout-btn">üö™ –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã</button>
            
            <h4>üìä –ò—Å—Ç–æ—Ä–∏—è –æ–ø–µ—Ä–∞—Ü–∏–π</h4>
            <div id="history"></div>
            
            <div id="bankMessage" class="message"></div>
        </div>
    </div>

    <script>
        // ID –≤–∞—à–µ–π Google –¢–∞–±–ª–∏—Ü—ã
        const SHEET_ID = '1UJzb281UvBZIGr9rE8y0hzvhHUt_G2YDnRYqlTi03xI';
        
        let currentUser = null;
        let allUsers = [];
        let transactions = [];
        
        // –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö (—É–±–∏—Ä–∞–µ–º –ø—Ä–æ–±–µ–ª—ã, –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ–º)
        function cleanData(data) {
            return data.map(user => ({
                ID: (user.ID || '').toString().trim(),
                Email: (user.Email || '').toString().trim().toLowerCase(),
                Password: (user.Password || '').toString().trim(),
                Balance: parseInt(user.Balance) || 50000,
                RegistrationDate: user.RegistrationDate || '2024-01-01'
            }));
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –∏–∑ Google Sheets
        async function loadUsers() {
            try {
                const url = `https://docs.google.com/spreadsheets/d/${SHEET_ID}/gviz/tq?tqx=out:json&sheet=Users`;
                const response = await fetch(url);
                const text = await response.text();
                
                if (text.includes('error')) {
                    throw new Error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —Ç–∞–±–ª–∏—Ü—ã');
                }
                
                const json = JSON.parse(text.substring(47).slice(0, -2));
                
                if (!json.table || !json.table.rows) {
                    throw new Error('–¢–∞–±–ª–∏—Ü–∞ –ø—É—Å—Ç–∞');
                }
                
                // –ü—Ä–µ–æ–±—Ä–∞–∑—É–µ–º –¥–∞–Ω–Ω—ã–µ
                const headers = json.table.cols.map(col => col.label);
                const rawUsers = json.table.rows.map(row => {
                    const obj = {};
                    headers.forEach((header, index) => {
                        obj[header] = row.c[index] ? row.c[index].v : '';
                    });
                    return obj;
                });
                
                // –û—á–∏—â–∞–µ–º –¥–∞–Ω–Ω—ã–µ
                allUsers = cleanData(rawUsers);
                
                // –ï—Å–ª–∏ –¥–∞–Ω–Ω—ã—Ö –º–∞–ª–æ, –¥–æ–±–∞–≤–ª—è–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö
                if (allUsers.length < 4) {
                    allUsers = [
                        {ID: '1', Email: 'tilyas@mail.ru', Password: '80223', Balance: 50000},
                        {ID: '2', Email: 'prokhor@mail.ru', Password: '71601', Balance: 50000},
                        {ID: '3', Email: 'roma@mail.ru', Password: '23312', Balance: 50000},
                        {ID: '4', Email: 'artem@mail.ru', Password: '94331', Balance: 50000}
                    ];
                }
                
                console.log('–ó–∞–≥—Ä—É–∂–µ–Ω—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:', allUsers);
                return allUsers;
                
            } catch (error) {
                console.error('–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏:', error);
                // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–µ—Å—Ç–æ–≤—ã—Ö –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
                allUsers = [
                    {ID: '1', Email: 'tilyas@mail.ru', Password: '80223', Balance: 50000},
                    {ID: '2', Email: 'prokhor@mail.ru', Password: '71601', Balance: 50000},
                    {ID: '3', Email: 'roma@mail.ru', Password: '23312', Balance: 50000},
                    {ID: '4', Email: 'artem@mail.ru', Password: '94331', Balance: 50000}
                ];
                return allUsers;
            }
        }
        
        // –í–æ–π—Ç–∏ –≤ —Å–∏—Å—Ç–µ–º—É
        async function login() {
            const email = document.getElementById('loginEmail').value.trim().toLowerCase();
            const password = document.getElementById('loginPassword').value.trim();
            
            if (!email || !password) {
                showMessage('loginMessage', '–í–≤–µ–¥–∏—Ç–µ email –∏ –ø–∞—Ä–æ–ª—å', 'error');
                return;
            }
            
            showMessage('loginMessage', '–ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö...', 'info');
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            await loadUsers();
            
            // –ò—â–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const user = allUsers.find(u => 
                u.Email === email && u.Password === password
            );
            
            if (user) {
                currentUser = user;
                showMessage('loginMessage', `‚úÖ –£—Å–ø–µ—à–Ω—ã–π –≤—Ö–æ–¥! –ë–∞–ª–∞–Ω—Å: ${user.Balance} ‚Çø`, 'success');
                
                // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —ç–∫—Ä–∞–Ω—ã
                document.getElementById('loginScreen').style.display = 'none';
                document.getElementById('bankScreen').style.display = 'block';
                document.getElementById('userName').textContent = email;
                document.getElementById('balance').textContent = `${user.Balance} ‚Çø`;
                
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
                fillUsersSelect();
                loadHistory();
                
            } else {
                showMessage('loginMessage', 
                    `‚ùå –ù–µ–≤–µ—Ä–Ω—ã–π email –∏–ª–∏ –ø–∞—Ä–æ–ª—å<br>
                    <small>–ü–æ–ø—Ä–æ–±—É–π—Ç–µ: tilyas@mail.ru / 80223</small>`, 
                    'error'
                );
            }
        }
        
        // –ó–∞–ø–æ–ª–Ω–∏—Ç—å —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π –¥–ª—è –ø–µ—Ä–µ–≤–æ–¥–∞
        function fillUsersSelect() {
            const select = document.getElementById('toEmail');
            select.innerHTML = '<option value="">–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è</option>';
            
            allUsers.forEach(user => {
                if (user.Email !== currentUser.Email) {
                    const option = document.createElement('option');
                    option.value = user.Email;
                    option.textContent = `${user.Email} (–ë–∞–ª–∞–Ω—Å: ${user.Balance} ‚Çø)`;
                    select.appendChild(option);
                }
            });
        }
        
        // –í—ã–ø–æ–ª–Ω–∏—Ç—å –ø–µ—Ä–µ–≤–æ–¥
        async function makeTransfer() {
            if (!currentUser) return;
            
            const toEmail = document.getElementById('toEmail').value;
            const amount = parseInt(document.getElementById('amount').value);
            
            if (!toEmail) {
                showMessage('bankMessage', '–í—ã–±–µ—Ä–∏—Ç–µ –ø–æ–ª—É—á–∞—Ç–µ–ª—è', 'error');
                return;
            }
            
            if (!amount || amount <= 0) {
                showMessage('bankMessage', '–í–≤–µ–¥–∏—Ç–µ —Å—É–º–º—É', 'error');
                return;
            }
            
            if (amount > currentUser.Balance) {
                showMessage('bankMessage', `‚ùå –ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤! –í–∞—à –±–∞–ª–∞–Ω—Å: ${currentUser.Balance} ‚Çø`, 'error');
                return;
            }
            
            // –ù–∞—Ö–æ–¥–∏–º –ø–æ–ª—É—á–∞—Ç–µ–ª—è
            const receiver = allUsers.find(u => u.Email === toEmail);
            if (!receiver) {
                showMessage('bankMessage', '–ü–æ–ª—É—á–∞—Ç–µ–ª—å –Ω–µ –Ω–∞–π–¥–µ–Ω', 'error');
                return;
            }
            
            // –°–æ–∑–¥–∞–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            const transaction = {
                id: transactions.length + 1,
                from: currentUser.Email,
                to: receiver.Email,
                amount: amount,
                date: new Date().toLocaleString('ru-RU'),
                status: 'success'
            };
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –±–∞–ª–∞–Ω—Å—ã
            currentUser.Balance -= amount;
            receiver.Balance += amount;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏—é
            transactions.push(transaction);
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ
            document.getElementById('balance').textContent = `${currentUser.Balance} ‚Çø`;
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
            showMessage('bankMessage', 
                `‚úÖ –ü–µ—Ä–µ–≤–æ–¥ –≤—ã–ø–æ–ª–Ω–µ–Ω!<br>
                <strong>${amount} ‚Çø</strong> ‚Üí <strong>${toEmail}</strong><br>
                –í–∞—à –Ω–æ–≤—ã–π –±–∞–ª–∞–Ω—Å: <strong>${currentUser.Balance} ‚Çø</strong>`, 
                'success'
            );
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∏—Å—Ç–æ—Ä–∏—é
            loadHistory();
            
            // –û–±–Ω–æ–≤–ª—è–µ–º —Å–ø–∏—Å–æ–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            fillUsersSelect();
            
            // –û—á–∏—â–∞–µ–º –ø–æ–ª–µ —Å—É–º–º—ã
            document.getElementById('amount').value = '';
            
            // –î–ª—è –†–ï–ê–õ–¨–ù–û–ì–û —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Google Sheets –Ω—É–∂–Ω–æ:
            // 1. Google Apps Script
            // 2. –ò–ª–∏ —Å–µ—Ä–≤–µ—Ä–Ω–∞—è —á–∞—Å—Ç—å
            // 3. –ò–ª–∏ –¥—Ä—É–≥–æ–π —Å–ø–æ—Å–æ–± –∑–∞–ø–∏—Å–∏
            
            console.log('–¢—Ä–∞–Ω–∑–∞–∫—Ü–∏—è:', transaction);
            console.log('–û–±–Ω–æ–≤–ª–µ–Ω–Ω—ã–µ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:', allUsers);
            
            // –í–æ—Ç –∑–¥–µ—Å—å –±—ã–ª –±—ã –∫–æ–¥ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –≤ Google Sheets
            // saveToGoogleSheets();
        }
        
        // –ó–∞–≥—Ä—É–∑–∏—Ç—å –∏—Å—Ç–æ—Ä–∏—é
        function loadHistory() {
            const historyDiv = document.getElementById('history');
            
            // –§–∏–ª—å—Ç—Ä—É–µ–º —Ç—Ä–∞–Ω–∑–∞–∫—Ü–∏–∏ —Ç–µ–∫—É—â–µ–≥–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
            const userTransactions = transactions.filter(t => 
                t.from === currentUser.Email || t.to === currentUser.Email
            );
            
            if (userTransactions.length === 0) {
                historyDiv.innerHTML = '<div class="message info">–ù–µ—Ç –æ–ø–µ—Ä–∞—Ü–∏–π</div>';
                return;
            }
            
            let html = '';
            userTransactions.reverse().forEach(trans => {
                const isOutgoing = trans.from === currentUser.Email;
                const type = isOutgoing ? 'üì§ –û—Ç–ø—Ä–∞–≤–ª–µ–Ω–æ' : 'üì• –ü–æ–ª—É—á–µ–Ω–æ';
                const otherUser = isOutgoing ? trans.to : trans.from;
                
                html += `
                    <div class="user-card">
                        <div><strong>${type}</strong></div>
                        <div>${isOutgoing ? '–ö–æ–º—É' : '–û—Ç'}: ${otherUser}</div>
                        <div>–°—É–º–º–∞: ${trans.amount} ‚Çø</div>
                        <div><small>${trans.date}</small></div>
                    </div>
                `;
            });
            
            historyDiv.innerHTML = html;
        }
        
        // –í—ã–π—Ç–∏ –∏–∑ —Å–∏—Å—Ç–µ–º—ã
        function logout() {
            currentUser = null;
            document.getElementById('loginScreen').style.display = 'block';
            document.getElementById('bankScreen').style.display = 'none';
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('loginMessage').textContent = '';
        }
        
        // –ü–æ–∫–∞–∑–∞—Ç—å —Å–æ–æ–±—â–µ–Ω–∏–µ
        function showMessage(elementId, text, type) {
            const element = document.getElementById(elementId);
            element.innerHTML = text;
            element.className = `message ${type}`;
            
            if (type !== 'info') {
                setTimeout(() => {
                    element.textContent = '';
                    element.className = 'message';
                }, 5000);
            }
        }
        
        // –ü—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.onload = async function() {
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π
            await loadUsers();
            console.log('–°–∏—Å—Ç–µ–º–∞ –≥–æ—Ç–æ–≤–∞. –ü–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–∏:', allUsers);
        };
    </script>
</body>
</html>
